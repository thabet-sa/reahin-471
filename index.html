<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>مسابقة صف خامس — لوحة المتابعة (مع تقدم أسبوعي)</title>

<link href="https://fonts.googleapis.com/css2?family=Rakkas&display=swap" rel="stylesheet">

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
  :root{
    --bg:#f3f6fb; --panel:#ffffff; --muted:#6b7280; --accent:#0ea5a4; --border:#e6eef8;
    --good:#f59e0b; --bad:#ef4444; --excellent:#10b981; --text:#0f1724; --panel-shadow: 0 6px 18px rgba(16,24,40,0.06);
    --grid-line: rgba(15,23,36,0.06);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Tahoma,Arial,"Segoe UI",sans-serif;direction:rtl;-webkit-font-smoothing:antialiased}
  .app{max-width:1200px;margin:16px auto;padding:14px}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
  .title-block{display:flex;flex-direction:column;align-items:flex-end}
  .title-main{font-weight:900;font-size:22px;margin:0}
  .display-font { font-family: 'Rakkas', Tahoma, Arial, sans-serif; }
  button{background:var(--panel);color:var(--text);padding:8px 10px;border:1px solid var(--border);border-radius:10px;cursor:pointer;box-shadow:var(--panel-shadow)}
  button.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  input,select,textarea{font-size:14px;color:var(--text)}
  /* Spreadsheet-like table styles */
  table{width:100%;border-collapse:collapse;margin-top:8px;background:transparent;table-layout:fixed;font-size:14px}
  th,td{border:1px solid var(--grid-line);padding:8px;text-align:center;vertical-align:middle;background:linear-gradient(180deg, rgba(255,255,255,0.85), rgba(255,255,255,0.7));word-wrap:break-word}
  thead th{background:linear-gradient(180deg,#f1f5f9,#ecfeff);font-weight:800;position:sticky;top:0;z-index:2}
  tbody tr:hover{background:linear-gradient(90deg, rgba(14,165,233,0.03), rgba(14,165,233,0.01))}
  .excel-like { box-shadow: 0 2px 8px rgba(2,6,23,0.04); border-radius:10px; overflow:auto; background: white; padding:8px; }
  textarea{width:100%;min-height:48px;padding:6px;border-radius:6px;background:#f8fafc;color:var(--text);border:1px solid var(--border);resize:vertical}
  input,select{padding:8px;border-radius:8px;border:1px solid var(--border);background:var(--panel);color:var(--text)}
  .nav{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}
  .nav button{background:transparent;border:1px solid transparent;color:var(--muted);padding:8px 12px;border-radius:10px}
  .nav button.active{background:var(--accent);color:#fff;border-color:var(--accent)}
  .center{display:flex;justify-content:center;align-items:center}
  .center-col{display:flex;flex-direction:column;align-items:center}
  .center-input{width:360px;border-radius:12px;padding:10px;border:1px solid var(--border);background:var(--panel);text-align:center}
  .honor{background:#eef9f8;padding:14px;border-radius:8px;margin-top:12px;border:1px solid var(--border);box-shadow:var(--panel-shadow)}
  .week-btn{padding:8px 12px;border-radius:10px;background:var(--panel);border:1px solid var(--border);cursor:pointer;color:var(--muted);display:flex;flex-direction:column;align-items:center;box-shadow:var(--panel-shadow)}
  .week-btn.active{background:var(--accent);color:#fff;border-color:var(--accent)}
  .muted{color:var(--muted)}
  .small{font-size:12px;color:var(--muted)}
  .inline-btn{padding:6px 8px;border-radius:8px;background:transparent;border:1px solid var(--border);cursor:pointer;color:var(--muted)}
  .danger{background:#fee2e2;color:var(--bad);border-color:#fbcaca}
  .fade{transition:opacity .18s ease, transform .18s ease}
  tr.faded { opacity: 0.45; }
  td[contenteditable] { outline: none; background: rgba(14,20,28,0.02); }
  select.score-select { padding:6px 8px; border-radius:6px; background:var(--panel); color:var(--text) }
  .grid-wrap{overflow:auto;max-height:62vh}
  .progress-wrap{width:100%;max-width:280px;margin:8px auto}
  .progress-bar{height:14px;border-radius:10px;background:linear-gradient(90deg, rgba(0,0,0,0.03), rgba(0,0,0,0.02));overflow:hidden;border:1px solid var(--border)}
  .progress-fill{height:100%;width:0%;background:var(--excellent);transition:width .5s ease}
  .badge{display:inline-block;padding:4px 8px;border-radius:8px;font-size:13px;margin-right:6px}
  .badge.warn{background:var(--good);color:#111}
  .badge.bad{background:var(--bad);color:#fff}
  .badge.ok{background:#265bff;color:#fff}
  .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:9999}
  .modal{background:var(--panel);padding:12px;border-radius:10px;max-width:720px;width:92%;box-shadow:var(--panel-shadow)}
  .hidden{display:none}
  .visitor-week { margin-top:12px; background:#fff;border-radius:8px;padding:8px;border:1px solid var(--border); }
  .visitor-week .week-title { display:flex;justify-content:space-between;align-items:center;margin-bottom:8px }
  .visitor-note { margin-top:8px;padding:8px;border-radius:8px;background:#f8fafc;border:1px solid var(--border) }
  .small-select { width:160px; padding:6px; border-radius:6px; }
  .visitor-table { table-layout:fixed; font-size:13px; }
  .visitor-table th, .visitor-table td { white-space:normal; word-break:break-word; vertical-align:top; padding:6px }
  .teacher-only { display:inline-block; }
  .rec-box { background:#fff8e6;border:1px solid #f5d7a9;padding:8px;border-radius:8px;margin-top:8px;color:#7a4a00 }
  .confirm-area { display:flex; gap:8px; margin-top:8px; justify-content:flex-start; align-items:center; }
  /* late styling */
  .late-row { background: linear-gradient(90deg, rgba(245,158,11,0.03), rgba(245,158,11,0.01)); }
  .late-indicator { font-weight:700; color:var(--good); margin-left:6px }
  /* sticky header row for days nav */
  .days-nav { display:flex; gap:8px; margin-top:8px; flex-wrap:wrap }
  @media (max-width:1100px){
    .app{padding:10px}
    .center-input{width:100%}
    .nav{display:none}
  }
  @media (max-width:800px){
    th,td{padding:6px;font-size:12px}
    .progress-wrap{max-width:220px}
    .title-main{font-size:18px}
    .grid-wrap{max-height:55vh}
  }
  @media (max-width:520px){
    header{flex-direction:column;align-items:stretch}
    button{width:100%}
    .progress-wrap{max-width:200px}
    table{font-size:12px}
    .small-select { width:120px; }
  }
</style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title-block">
        <div class="title-main display-font">مسابقة صف خامس</div>
        <div class="title-sub">أ.ثابت الطواله</div>
      </div>

      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <input id="codeInput" type="password" placeholder="ادخل الرمز(خاص بالمعلم)" style="padding:10px;border-radius:10px;background:var(--panel);border:1px solid var(--border);color:var(--text)">
        <button id="enterBtn" class="primary">دخول</button>
        <button id="logoutBtn" style="display:none">خروج</button>
      </div>
    </header>

    <div class="nav" id="mainNav" style="display:none">
      <button id="tabHome" class="active">الرئيسية</button>
      <button id="tabTests">الاختبارات</button>
      <button id="tabHonor">لوحة الشرف</button>
      <button id="tabStats">إحصائيات</button>
      <button id="tabManage">إدارة الطلاب</button>
      <button id="tabSupervisor">عرض المشرف</button>
    </div>

    <!-- Visitor / Parent -->
    <div id="visitorArea" class="center-col" style="gap:12px;margin-top:12px">
      <div class="center-col" style="width:100%;align-items:center">
        <input id="parentCodeInput" class="center-input" placeholder="ادخل رمز ولي الأمر فقط">
        <div style="margin-top:10px;display:flex;gap:8px;width:92%;max-width:760px">
          <button id="visitorShow" class="primary" style="flex:1">عرض</button>
        </div>
      </div>

      <div id="publicHonor" class="honor" style="width:100%;max-width:920px;display:none">
        <h3 class="display-font" style="margin:6px 0">لوحة الشرف الأسبوعية</h3>
        <div id="publicHonorList" class="small">تحميل...</div>
        <div id="publicHonorMessage" class="public-honor-message" style="display:none"></div>
      </div>

      <div id="visitorResult" style="width:100%;max-width:1100px;margin-top:12px"></div>
    </div>

    <!-- Teacher main UI (home) -->
    <div id="appUI" class="hidden" style="margin-top:12px">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <div id="weeksBox" style="display:flex;gap:8px;flex-wrap:wrap"></div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <button id="prevWeek" class="inline-btn">◀️</button>
          <button id="nextWeek" class="inline-btn">▶️</button>
          <button id="addWeek" class="week-btn teacher-only">+ أضف أسبوع</button>
          <button id="delWeek" class="week-btn danger teacher-only">حذف الأسبوع</button>
        </div>
      </div>

      <div id="weekTitle" style="margin-top:10px"></div>
      <div class="grid-wrap grid-scroll excel-like" id="gridWrap" style="margin-top:12px"></div>
    </div>

    <!-- Tests page -->
    <section id="testsPage" class="hidden" style="margin-top:12px">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
        <h2>صفحة الاختبارات</h2>
        <div style="display:flex;gap:8px">
          <button id="testsAddBtn" class="primary teacher-only">+ أضف اختبار</button>
          <button id="testsBackupBtn" class="inline-btn teacher-only">حفظ نسخة محلية</button>
          <button id="testsSaveBtn" class="primary teacher-only" style="display:none">تأكيد الحفظ</button>
        </div>
      </div>
      <div id="testsContainer" style="margin-top:10px"></div>
    </section>

    <!-- Honor editor page (manual) -->
    <section id="honorPage" class="hidden" style="margin-top:12px">
      <h2 class="display-font">لوحة الشرف</h2>
      <div id="honorContent" class="honor" style="margin-top:8px"></div>
    </section>

    <!-- Stats page -->
    <section id="statsPage" class="hidden" style="margin-top:12px">
      <h2>إحصائيات الحضور والتأخير والمراكز الأسبوعية</h2>
      <div id="statsContent" style="margin-top:8px"></div>
    </section>

    <!-- Manage students page -->
    <section id="managePage" class="hidden" style="margin-top:12px">
      <h2>إدارة الطلاب</h2>
      <div>
        <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
          <input id="newStudentName" placeholder="اسم الطالب الجديد" style="padding:8px;border-radius:8px;border:1px solid var(--border);flex:1">
          <button id="addStudentBtn" class="primary">إضافة طالب</button>
        </div>
        <div class="manage-list" id="manageList"></div>
      </div>
    </section>

    <!-- Supervisor-only panel -->
    <div id="supervisorOnly" class="hidden" style="margin-top:12px">
      <h2 style="text-align:center">عرض المشرف</h2>
      <div id="supervisorControls" style="display:flex;gap:8px;align-items:center;justify-content:center;margin-top:8px">
        <input id="supervisorSearch" placeholder="ابحث باسم الطالب..." style="padding:10px;border-radius:8px;border:1px solid var(--border);width:320px">
        <button id="supervisorSearchBtn" class="inline-btn">بحث</button>
      </div>
      <div id="supervisorContainer" class="grid-wrap grid-scroll" style="margin-top:12px"></div>
    </div>
  </div>

<div id="modalRoot"></div>

<script>
/* ---------------- Firebase config ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyBtRfu6QqoJFO8LpP8KjC4UNO7osnae3c8",
  authDomain: "riahen-5.firebaseapp.com",
  databaseURL: "https://riahen-5-default-rtdb.firebaseio.com",
  projectId: "riahen-5",
  storageBucket: "riahen-5.firebasestorage.app",
  messagingSenderId: "492417113789",
  appId: "1:492417113789:web:3629c70fe7b50c403c21d4",
  measurementId: "G-TRGSYPBV1F"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ---------------- Data & defaults ---------------- */
let students = [
  'سعود الرومي','سعد الفريح','فارس البداح','عبدالرحمن القشعمي',
  'عبدالحكيم الحمد','حسام الطريقي','هشام الفايز',
  'عبدالرحمن الفرهود','ابراهيم المتعب','سليمان الفرهود','سليمان القشعمي','سليمان الدويش'
];
const defaultDays = ['الأحد','الإثنين','الثلاثاء','الأربعاء','الخميس'];

let dashboard = null;
let role = 'visitor'; // visitor | teacher | supervisor
let currentWeek = 0;
let currentDay = 0;
let currentTab = 'home';
let parentSession = null; // { code, childId }
let tempHonor = null; // staging copy for honor edits
let testsDirty = false;

/* ---------- preset notes (updated as requested) ---------- */
const presetNotes = {
  positive: [
    'ممتاز! استمر على هذا الأداء.',
    'تحسن واضح — عمل رائع.',
    'أداء متميز، بارك الله في جهودك.',
    'مميز دائما ، واصل إبداعك يا بطل.'
  ],
  warning: [
    'بحاجة إلى متابعة واجتهاد أكثر.',
    'شد حيلك يا بطل.',
    'انخفاض ملحوظ — الرجاء الحرص والمتابعة.',
    'لم يتم الحفظ والمراجعة❗'
  ]
};

/* ---------- helpers ---------- */
function tokenToNumber(token){
  if(!token && token!=='0') return 0;
  if(token==='3-star' || token==='3-check') return 3;
  if(token==='2') return 2;
  if(token==='1') return 1;
  if(token==='0') return 0;
  const n = Number(token);
  return isNaN(n)?0:n;
}
function tokenToNumericForCalc(token, field){
  if(!token && token!=='0') return 0;
  if(field === 'حفظ'){
    if(token === '3-star') return 4;
    if(token === '3-check') return 3;
  }
  if(token==='3-star' || token==='3-check') return 3;
  if(token==='2') return 2;
  if(token==='1') return 1;
  if(token==='0') return 0;
  const n = Number(token);
  return isNaN(n)?0:n;
}
function tokenToEmoji(token){
  if(!token && token!=='0') return '';
  if(token==='3-star') return '⭐️';
  if(token==='3-check') return '✅';
  if(token==='2') return '⚠️';
  if(token==='1') return '⚠️';
  if(token==='0') return '❌';
  return token;
}
function absenceLabel(a){
  if(!a || a==='present') return 'حاضر';
  if(a==='excused') return 'غائب بعذر';
  if(a==='unexcused') return 'غائب بدون';
  if(a==='late') return 'متأخر';
  return a;
}
function escapeHtml(s){ return (''+s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function deepCopy(o){ return JSON.parse(JSON.stringify(o)); }

/* Display score for parent: show 0 (zero) explicitly if present */
function displayScoreForParent(token){
  if(token === undefined || token === null || token === '') return '';
  const n = tokenToNumber(token);
  const emoji = tokenToEmoji(token);
  // tokenToEmoji may return the emoji for special tokens and numeric text for plain numbers.
  // detect if tokenToEmoji produced a non-digit (an emoji) and prefer that; otherwise map by numeric value.
  const hasEmoji = /[^0-9\s\-]/.test(emoji);
  if(hasEmoji){
    return `${n} ${emoji}`;
  }
  let mapEmoji = '';
  if(n >= 3) mapEmoji = '⭐️';
  else if(n === 2) mapEmoji = '⚠️';
  else if(n === 1) mapEmoji = '⚠️';
  else mapEmoji = '❌';
  return `${n} ${mapEmoji}`;
}

/* ---------- DB load/save ---------- */
async function loadDashboard(){
  const snap = await db.ref('dashboard').get();
  if(snap.exists()){ dashboard = snap.val(); ensureStructure(); }
  else { dashboard = createDefault(); await saveDashboard(); }
  // listen for live updates
  db.ref('dashboard').on('value', s=>{
    if(s.exists()){
      dashboard = s.val();
      ensureStructure();
      renderAll();
      applyVisitorModeIfNeeded();
    }
  });
  renderAll();
  applyVisitorModeIfNeeded();
}
function saveDashboard(){ return db.ref('dashboard').set(dashboard).catch(err=>{ console.error('Save error', err); throw err; }); }

function createDefault(){
  const weeks = [];
  for(let w=1; w<=4; w++){
    const week = { title:`الأسبوع ${w}`, days:[] , approved: false };
    defaultDays.forEach(d=>{
      const rows = students.map((name,i)=>({ id:i,name, absence:'present', حفظ:'', تثبيت:'', مراجعة:'', سلوك:'', note:'' }));
      week.days.push({ title:d, date:'', rows, honorPositions: [] });
    });
    weeks.push(week);
  }
  const tests = { exams:[], scores: students.map((s,i)=>({ id:i, name:s, grades:{} })) };
  const honor = { positions: [ {title:'المركز الأول', studentId:null, customName:''}, {title:'المركز الثاني', studentId:null, customName:''}, {title:'المركز الثالث', studentId:null, customName:''} ], publicMessage: '' };
  const parents = []; // { code, childId, parentName, visitCount, lastVisit }
  const adminCodes = { teacher: ['0059'], supervisor: ['1234'] };
  return { weeks, tests, honor, parents, adminCodes };
}

function ensureStructure(){
  if(!dashboard) dashboard = createDefault();
  if(!Array.isArray(dashboard.weeks)) dashboard.weeks = [];
  dashboard.weeks = dashboard.weeks.map((w, wi) => {
    if(!w || typeof w !== 'object') w = { title: `الأسبوع ${wi+1}`, days: [], approved: false };
    if(!Array.isArray(w.days) || w.days.length === 0){
      w.days = defaultDays.map(d => ({ title: d, date: '', rows: students.map((name,i)=>({ id:i, name, absence:'present', حفظ:'', تثبيت:'', مراجعة:'', سلوك:'', note:'' })), honorPositions: [] }));
    } else {
      w.days = w.days.map((d, di) => {
        if(!d || typeof d !== 'object') d = { title: defaultDays[di] || `اليوم ${di+1}`, date:'', rows: [], honorPositions: [] };
        if(!Array.isArray(d.rows) || d.rows.length !== students.length){
          d.rows = students.map((name,i)=>({ id:i, name, absence:'present', حفظ:'', تثبيت:'', مراجعة:'', سلوك:'', note:'' }));
        } else {
          d.rows = d.rows.map((r, i) => {
            if(!r || typeof r !== 'object') r = { id:i, name: students[i], absence:'present', حفظ:'', تثبيت:'', مراجعة:'', سلوك:'', note:'' };
            r.id = i;
            r.name = r.name || students[i];
            r.absence = r.absence || 'present';
            if(r.حفظ===undefined) r.حفظ = '';
            if(r.تثبيت===undefined) r.تثبيت = '';
            if(r.مراجعة===undefined) r.مراجعة = '';
            if(r.سلوك===undefined) r.سلوك = '';
            if(r.note===undefined) r.note = '';
            return r;
          });
        }
        if(!Array.isArray(d.honorPositions)) d.honorPositions = [];
        return d;
      });
    }
    if(!Array.isArray(w.honorPositions)) w.honorPositions = [];
    if(w.approved===undefined) w.approved = false;
    return w;
  });

  if(!dashboard.tests || typeof dashboard.tests !== 'object') dashboard.tests = { exams: [], scores: students.map((s,i)=>({ id:i, name:s, grades:{} })) };
  if(!Array.isArray(dashboard.tests.scores) || dashboard.tests.scores.length !== students.length){
    dashboard.tests.scores = students.map((s,i)=>({ id:i, name:s, grades:{} }));
  } else {
    dashboard.tests.scores = dashboard.tests.scores.map((st,i)=>({ id:i, name: students[i], grades: st.grades || {} }));
  }

  if(!dashboard.honor || typeof dashboard.honor !== 'object') dashboard.honor = createDefault().honor;
  if(dashboard.honor.publicMessage===undefined) dashboard.honor.publicMessage = '';
  if(!Array.isArray(dashboard.parents)) dashboard.parents = [];
  dashboard.parents = dashboard.parents.map(p=>{
    if(!p) return p;
    if(p.visitCount===undefined) p.visitCount = 0;
    if(p.lastVisit===undefined) p.lastVisit = '';
    return p;
  });
  if(!dashboard.adminCodes) dashboard.adminCodes = { teacher: ['0059'], supervisor: ['1234'] };
}

/* ---------- UI refs ---------- */
const enterBtn = document.getElementById('enterBtn'), logoutBtn = document.getElementById('logoutBtn'), codeInput = document.getElementById('codeInput');
const visitorArea = document.getElementById('visitorArea'), parentCodeInput = document.getElementById('parentCodeInput'), visitorShow = document.getElementById('visitorShow');
const publicHonorList = document.getElementById('publicHonorList'), publicHonorWrap = document.getElementById('publicHonor');
const publicHonorMessage = document.getElementById('publicHonorMessage');
const visitorResult = document.getElementById('visitorResult');
const appUI = document.getElementById('appUI'), weeksBox = document.getElementById('weeksBox'), weekTitle = document.getElementById('weekTitle'), gridWrap = document.getElementById('gridWrap');
const addWeekBtn = document.getElementById('addWeek'), delWeekBtn = document.getElementById('delWeek'), prevWeek = document.getElementById('prevWeek'), nextWeek = document.getElementById('nextWeek');
const honorPage = document.getElementById('honorPage'), honorContent = document.getElementById('honorContent');
const supervisorOnly = document.getElementById('supervisorOnly'), supervisorContainer = document.getElementById('supervisorContainer');
const tabHome = document.getElementById('tabHome'), tabTests = document.getElementById('tabTests'), tabHonor = document.getElementById('tabHonor'), tabStats = document.getElementById('tabStats'), tabSupervisor = document.getElementById('tabSupervisor'), tabManage = document.getElementById('tabManage');
const testsPage = document.getElementById('testsPage'), testsContainer = document.getElementById('testsContainer');
const testsAddBtn = document.getElementById('testsAddBtn'), testsBackupBtn = document.getElementById('testsBackupBtn'), testsSaveBtn = document.getElementById('testsSaveBtn');
const statsPage = document.getElementById('statsPage'), statsContent = document.getElementById('statsContent');
const modalRoot = document.getElementById('modalRoot');
const managePage = document.getElementById('managePage'), manageList = document.getElementById('manageList'), addStudentBtn = document.getElementById('addStudentBtn'), newStudentName = document.getElementById('newStudentName');
const supervisorSearch = document.getElementById('supervisorSearch'), supervisorSearchBtn = document.getElementById('supervisorSearchBtn');

/* ---------- role handling ---------- */
enterBtn.addEventListener('click', ()=>{
  const code = codeInput.value.trim();
  if(code==='0059'){ role='teacher'; }
  else if(code==='1234'){ role='supervisor'; }
  else {
    if(dashboard && dashboard.adminCodes){
      const ac = dashboard.adminCodes;
      if(Array.isArray(ac.teacher) && ac.teacher.includes(code)) role='teacher';
      else if(Array.isArray(ac.supervisor) && ac.supervisor.includes(code)) role='supervisor';
      else role='visitor';
    } else { role='visitor'; }
  }
  onRoleChange();
});
logoutBtn.addEventListener('click', ()=>{ role='visitor'; codeInput.value=''; onRoleChange(); parentSession = null; parentCodeInput.value=''; renderAll(); });

function onRoleChange(){
  document.getElementById('visitorArea').style.display='none';
  appUI.style.display='none';
  document.getElementById('mainNav').style.display='none';
  honorPage.style.display='none';
  testsPage.style.display='none';
  statsPage.style.display='none';
  managePage.style.display='none';
  supervisorOnly.style.display='none';

  if(role==='supervisor'){
    supervisorOnly.style.display='block';
    logoutBtn.style.display='inline-block';
    renderSupervisorControls();
    applyVisitorModeIfNeeded();
    renderSupervisorDetailed();
    showParentInactivityModalIfNeeded(2);
    return;
  }
  if(role==='teacher'){
    appUI.style.display='block';
    document.getElementById('mainNav').style.display='flex';
    logoutBtn.style.display='inline-block';
    document.querySelectorAll('.teacher-only').forEach(el=>el.style.display='inline-block');
    setActiveNav('home');
    renderWeeks(); renderGrid();
    applyVisitorModeIfNeeded();
    showParentInactivityModalIfNeeded(2);
    return;
  }
  visitorArea.style.display='flex';
  document.getElementById('mainNav').style.display='none';
  logoutBtn.style.display='none';
  visitorResult.innerHTML='';
  applyVisitorModeIfNeeded();
}

function hideVisitorControls(){
  const selectors = ['.inline-btn','.danger','.teacher-only','#delWeek','#addWeek','#prevWeek','#nextWeek'];
  selectors.forEach(sel=>document.querySelectorAll(sel).forEach(el=>{ if(el){ el.style.display = 'none'; el.disabled = true; el.setAttribute('aria-hidden','true'); }}));
}
function restoreControls(){
  document.querySelectorAll('.inline-btn, .danger, .teacher-only, #delWeek, #addWeek, #prevWeek, #nextWeek').forEach(el=>{ el.style.display = ''; el.disabled = false; el.removeAttribute('aria-hidden'); });
}
function applyVisitorModeIfNeeded(){ if(role === 'visitor') hideVisitorControls(); else restoreControls(); }

function setActiveNav(n){ document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('active')); if(n==='home'&&tabHome) tabHome.classList.add('active'); if(n==='tests'&&tabTests) tabTests.classList.add('active'); if(n==='honor'&&tabHonor) tabHonor.classList.add('active'); if(n==='stats'&&tabStats) tabStats.classList.add('active'); if(n==='supervisor'&&tabSupervisor) tabSupervisor.classList.add('active'); if(n==='manage'&&tabManage) tabManage.classList.add('active'); }
tabHome && tabHome.addEventListener('click', ()=>{ currentTab='home'; setActiveNav('home'); showSection('home'); });
tabTests && tabTests.addEventListener('click', ()=>{ currentTab='tests'; setActiveNav('tests'); showSection('tests'); });
tabHonor && tabHonor.addEventListener('click', ()=>{ currentTab='honor'; setActiveNav('honor'); showSection('honor'); });
tabStats && tabStats.addEventListener('click', ()=>{ currentTab='stats'; setActiveNav('stats'); showSection('stats'); });
tabSupervisor && tabSupervisor.addEventListener('click', ()=>{ currentTab='supervisor'; setActiveNav('supervisor'); showSection('supervisor'); });
tabManage && tabManage.addEventListener('click', ()=>{ currentTab='manage'; setActiveNav('manage'); showSection('manage'); });

function showSection(name){
  visitorArea.style.display='none';
  appUI.style.display='none';
  honorPage.style.display='none';
  testsPage.style.display='none';
  statsPage.style.display='none';
  managePage.style.display='none';
  supervisorOnly.style.display='none';

  if(role==='visitor'){ visitorArea.style.display='flex'; applyVisitorModeIfNeeded(); return; }

  if(name==='home'){ appUI.style.display='block'; renderGrid(); }
  else if(name==='tests'){ testsPage.style.display='block'; renderTestsPage(); }
  else if(name==='honor'){ honorPage.style.display='block'; renderHonorEditor(); }
  else if(name==='stats'){ statsPage.style.display='block'; renderStatsPage(); }
  else if(name==='manage'){ managePage.style.display='block'; renderManagePage(); }
  else if(name==='supervisor'){ supervisorOnly.style.display='block'; renderSupervisorDetailed(); }
  applyVisitorModeIfNeeded();
}

/* ---------- Public honor rendering ---------- */
function renderPublicHonor(){
  const c = publicHonorList;
  publicHonorWrap.style.display = 'block';
  if(!dashboard || !dashboard.honor || !Array.isArray(dashboard.honor.positions) || dashboard.honor.positions.length===0){
    c.innerHTML = 'لا توجد مراكز';
    publicHonorMessage.style.display = (dashboard && dashboard.honor && dashboard.honor.publicMessage) ? 'block' : 'none';
    publicHonorMessage.innerHTML = dashboard && dashboard.honor ? escapeHtml(dashboard.honor.publicMessage || '') : '';
    return;
  }
  let html = '<ol style="text-align:right;padding-right:12px;margin:0">';
  dashboard.honor.positions.forEach((p,idx)=>{
    const name = (p.studentId!==null && p.studentId!==undefined && students[p.studentId]) ? students[p.studentId] : (p.customName||'—');
    const title = p.title || ('المركز '+(idx+1));
    html += `<li style="margin:6px 0">${escapeHtml(title)} — <strong>${escapeHtml(name)}</strong></li>`;
  });
  html += '</ol>';
  c.innerHTML = html;
  if(dashboard.honor.publicMessage && dashboard.honor.publicMessage.trim() !== ''){
    publicHonorMessage.style.display = 'block';
    publicHonorMessage.innerHTML = escapeHtml(dashboard.honor.publicMessage);
  } else {
    publicHonorMessage.style.display = 'none';
    publicHonorMessage.innerHTML = '';
  }
}

/* ---------- renderAll ---------- */
function renderAll(){
  renderPublicHonor();
  if(role==='visitor'){
    const sid = visitorResult.getAttribute('data-student-id'); if(sid) renderVisitorResult(Number(sid));
  } else if(role==='teacher'){
    renderWeeks(); renderGrid();
  }
  applyVisitorModeIfNeeded();
}

/* ---------- Parent handling (robust, non-blocking, validates childId) ---------- */
function parentLoginWithCode(pcode){
  const raw = (pcode||'').trim();
  if(!raw) { alert('أدخل رمز ولي الأمر.'); return; }
  if(!dashboard || !Array.isArray(dashboard.parents)) { alert('لا توجد بيانات أولياء أمور.'); return; }

  const needle = raw.toLowerCase();
  const entry = dashboard.parents.find(p=>{
    if(!p || !p.code) return false;
    return (''+p.code).trim().toLowerCase() === needle;
  });

  if(!entry){ alert('الرمز غير صحيح.'); return; }

  // Validate childId
  const childId = Number(entry.childId);
  if(Number.isNaN(childId) || childId < 0 || childId >= students.length){
    alert('رمز الولي صحيح لكنه غير مربوط بطالب صالح. اتصل بالمعلم لتصحيح الكود.');
    return;
  }

  // Set session & render immediately so UI is responsive (do not wait for save)
  parentSession = { code: entry.code, childId: childId };
  role = 'visitor';
  onRoleChange();
  try { renderVisitorResult(childId); } catch(err){ console.error('Error rendering visitor view', err); alert('حدث خطأ أثناء عرض البيانات.'); }

  // Update counts and persist in background (non-blocking)
  try {
    entry.visitCount = (entry.visitCount||0) + 1;
    entry.lastVisit = new Date().toISOString();
    // save but do not block the UI; handle error if it fails
    saveDashboard().catch(err=>{
      console.error('Failed to save parent visit:', err);
      alert('تم التسجيل محليًا لكن لم يتم حفظ الزيارة في الخادم (تحقق من الاتصال).');
    });
  } catch(e){
    console.error('Error updating parent record', e);
  }
}

// wire the button (single handler)
visitorShow.addEventListener('click', ()=>{ parentLoginWithCode(parentCodeInput.value); });

/* ---------- ranking utilities ---------- */
function computeWeekRanks(weekIndex){
  const week = dashboard.weeks[weekIndex];
  if(!week) return null;
  if(!week.aiProgress || !Array.isArray(week.aiProgress.percents)) computeAiWeightedProgressForWeek(weekIndex, { save:false });
  const percents = (week.aiProgress && week.aiProgress.percents) ? week.aiProgress.percents.slice() : [];
  const arr = percents.map((p,i)=>({ id:i, percent: p }));
  arr.sort((a,b)=>b.percent - a.percent);
  const ranks = new Array(students.length).fill(null);
  if(arr.length === 0) return ranks;
  // Assign ranks with ties receiving the same rank, and the next distinct score receiving the next sequential rank.
  let currentRank = 1;
  let distinctCount = 1;
  ranks[arr[0].id] = currentRank;
  for(let i=1;i<arr.length;i++){
    if(arr[i].percent < arr[i-1].percent){
      distinctCount++;
      currentRank = distinctCount;
    }
    ranks[arr[i].id] = currentRank;
  }
  return ranks;
}

/* ---------- AI-weighted progress ---------- */
function computeAiWeightedProgressForWeek(weekIndex, options={save:false}){
  const week = dashboard.weeks[weekIndex];
  if(!week) return null;
  const weights = { 'حفظ':0.30, 'تثبيت':0.20, 'مراجعة':0.40, 'سلوك':0.10 };
  const perFieldMax = { 'حفظ':4, 'تثبيت':3, 'مراجعة':3, 'سلوك':3 };

  // If week is approved, treat empty days (no student recorded any field) as cancelled
  let daysIndices = week.days.map((d, i) => i);
  if(week.approved){
    daysIndices = daysIndices.filter(di=>{
      const d = week.days[di];
      for(const r of d.rows){
        for(const f of Object.keys(weights)){
          if(r[f] !== undefined && r[f] !== null && r[f] !== '') return true;
        }
      }
      return false; // day is empty -> remove
    });
    if(daysIndices.length === 0){
      daysIndices = week.days.map((d,i)=>i);
    }
  }

  const percents = new Array(students.length).fill(0);
  const totals = new Array(students.length).fill(0);

  for(let si=0; si<students.length; si++){
    let score = 0;
    let absencePenalty = 0;
    for(let diIndex=0; diIndex<daysIndices.length; diIndex++){
      const di = daysIndices[diIndex];
      const r = week.days[di].rows[si] || {};
      Object.keys(weights).forEach(f=>{
        const val = tokenToNumericForCalc(r[f], f);
        const fieldMax = perFieldMax[f] || 3;
        score += (val / fieldMax) * weights[f];
        totals[si] += val;
      });
      if(r.absence==='excused') absencePenalty += 0.00;
      if(r.absence==='unexcused') absencePenalty += 0.05;
      if(r.absence==='late') absencePenalty += 0.01;
    }
    const daysCount = daysIndices.length || 1;
    const normalized = score / daysCount;
    let finalScore = normalized - absencePenalty;
    if(finalScore < 0) finalScore = 0;
    let percent = Math.round(finalScore * 100);
    if(percent < 0) percent = 0; if(percent > 100) percent = 100;
    percents[si] = percent;
  }

  week.aiProgress = week.aiProgress || {};
  week.aiProgress.percents = percents;
  week.aiProgress.totals = totals;
  week.aiProgress.messages = percents.map(p=> p<80? 'يحتاج متابعة' : (p<=90? 'جيد' : 'ممتاز واصل يا بطل'));
  if(options.save) saveDashboard();
  return { percents, totals, messages: week.aiProgress.messages };
}

/* ---------- compute progress & suggestions ---------- */
function computeProgressForWeek(weekIndex, options={save:false}){
  const week = dashboard.weeks[weekIndex];
  if(!week) return null;
  const daysCount = week.days.length;
  const fieldsPerDay = ['حفظ','تثبيت','مراجعة','سلوك'];
  const perFieldMax = { 'حفظ':4, 'تثبيت':3, 'مراجعة':3, 'سلوك':3 };
  const maxPossible = daysCount * Object.values(perFieldMax).reduce((a,b)=>a+b,0);
  const totals = new Array(students.length).fill(0);
  for(let di=0; di<daysCount; di++){ const d = week.days[di]; d.rows.forEach((r,si)=>{ fieldsPerDay.forEach(f=>{ totals[si] += tokenToNumericForCalc(r[f], f); }); }); }
  const percents = totals.map(t=> maxPossible>0 ? (t / maxPossible) * 100 : 0 );
  const messages = percents.map(p=> p<80? 'يحتاج متابعة' : (p<=90? 'جيد' : 'ممتاز واصل يا بطل') );
  week.computed = week.computed || {};
  week.computed.totals = totals; week.computed.percents = percents; week.computed.messages = messages;
  computeAiWeightedProgressForWeek(weekIndex, { save:false });
  if(options.save) saveDashboard();
  return { totals, percents, messages, maxPossible };
}

/* ---------- render progress bar + comparison ---------- */
function renderProgressBarHtml(percent,msg){
  const p = Math.round(percent);
  let badgeHtml = '', color = 'var(--excellent)';
  if(p < 80){ badgeHtml = `<span class="badge bad">يحتاج متابعة</span>`; color='var(--bad)'; }
  else if(p >=80 && p <=90){ badgeHtml = `<span class="badge warn">جيد ⚠️</span>`; color='var(--good)'; }
  else { badgeHtml = `<span class="badge ok">ممتاز ⭐️</span>`; color='var(--excellent)'; }
  const html = `<div class="progress-wrap"><div class="progress-bar"><div class="progress-fill" style="width:${p}%;background:${color}"></div></div><div style="margin-top:6px;font-size:13px">${p}% ${msg?('<div class="small muted">'+escapeHtml(msg)+'</div>'):''}</div>${badgeHtml}</div>`;
  return html;
}
function renderComparisonBar(curr, prev){
  const c = Math.round(curr||0), p = Math.round(prev||0);
  const diff = c - p;
  const sign = diff>0 ? '+' : '';
  const cls = diff>0 ? 'delta-up' : (diff<0 ? 'delta-down' : 'small muted');
  const prevWidth = Math.max(0, Math.min(100, p));
  const currWidth = Math.max(0, Math.min(100, c));
  const html = `<div style="margin-top:6px;text-align:right"><div class="small muted">مقارنة بالأسبوع الماضي: ${p}% → ${c}% &nbsp; <span class="${cls}">${sign}${diff}%</span></div>
    <div style="margin-top:6px;height:12px;border-radius:8px;background:#f1fbfa;border:1px solid var(--border);overflow:hidden"><div style="height:100%;width:${prevWidth}%;background:rgba(16,185,129,0.25);display:inline-block"></div><div style="height:100%;width:${currWidth}%;background:var(--accent);display:inline-block;opacity:0.9"></div></div></div>`;
  return html;
}
function renderInlineProgressBar(avg, msg){
  const p = Math.round(avg);
  let color = 'var(--excellent)';
  if(p < 80) color = 'var(--bad)';
  else if(p <= 90) color = 'var(--good)';
  return `<div style="display:flex;flex-direction:column;align-items:center"><div class="progress-bar" style="width:120px"><div class="progress-fill" style="width:${p}%;background:${color}"></div></div><div class="small muted" style="margin-top:6px">${escapeHtml(msg||'')}</div></div>`;
}

/* ---------- Honor editor (teacher) with staging + confirm ---------- */
function renderHonorEditor(){
  honorContent.innerHTML = '';

  // start staging copy if not exist
  if(!tempHonor) tempHonor = deepCopy(dashboard.honor || { positions:[], publicMessage: '' });

  if(!tempHonor.positions || tempHonor.positions.length===0){
    tempHonor.positions = [ {title:'المركز الأول', studentId:null, customName:''}, {title:'المركز الثاني', studentId:null, customName:''}, {title:'المركز الثالث', studentId:null, customName:''} ];
  }

  const wrapper = document.createElement('div');

  // title
  const instr = document.createElement('div'); instr.className='small muted'; instr.style.marginBottom='8px';
  instr.textContent = 'التعديلات تحفظ فقط بعد الضغط على "تأكيد الحفظ". (يمكن إلغاء التغييرات بالضغط على "إلغاء")';
  wrapper.appendChild(instr);

  // global honor editor (editing tempHonor)
  const globalH = document.createElement('div');
  globalH.innerHTML = '<h3>المراكز العامة (للمعلم)</h3>';
  tempHonor.positions.forEach((p,idx)=>{
    const row = document.createElement('div'); row.style.display='flex'; row.style.gap='8px'; row.style.marginBottom='6px'; row.style.alignItems='center';
    const medal = document.createElement('div'); medal.textContent = idx===0?'🥇':idx===1?'🥈':idx===2?'🥉':'🏅';
    const titleInp = document.createElement('input'); titleInp.value = p.title||('المركز '+(idx+1));
    titleInp.addEventListener('input', ()=>{ tempHonor.positions[idx].title = titleInp.value; });
    const sel = document.createElement('select'); const emptyOpt = document.createElement('option'); emptyOpt.value=''; emptyOpt.textContent='— اختَر طالب —'; sel.appendChild(emptyOpt);
    students.forEach((s,sid)=>{ const o=document.createElement('option'); o.value=sid; o.textContent=s; if(p.studentId===sid) o.selected=true; sel.appendChild(o); });
    sel.onchange = ()=>{ const v = sel.value; tempHonor.positions[idx].studentId = v===''? null : Number(v); };
    const custom = document.createElement('input'); custom.placeholder='اسم مخصص (اختياري)'; custom.value = p.customName||''; custom.addEventListener('input', ()=>{ tempHonor.positions[idx].customName = custom.value; });
    const rem = document.createElement('button'); rem.textContent='إزالة'; rem.onclick = ()=>{ if(!confirm('حذف هذا المركز من المسودة؟')) return; tempHonor.positions.splice(idx,1); renderHonorEditor(); };
    row.append(medal,titleInp,sel,custom,rem); globalH.appendChild(row);
  });
  const addGlobal = document.createElement('button'); addGlobal.textContent='+ مركز'; addGlobal.onclick = ()=>{ tempHonor.positions.push({ title:'المركز '+(tempHonor.positions.length+1), studentId:null, customName:'' }); renderHonorEditor(); };
  globalH.appendChild(addGlobal);
  wrapper.appendChild(globalH);

  // PUBLIC MESSAGE editor (staged)
  const pmMsg = document.createElement('div'); pmMsg.style.marginTop='12px';
  pmMsg.innerHTML = '<h3>رسالة عامة تحت لوحة الشرف (تظهر للجميع)</h3>';
  const ta = document.createElement('textarea'); ta.placeholder = 'اكتب رسالة قصيرة تظهر تحت لوحة الشرف للجميع...'; ta.style.minHeight='80px';
  ta.value = tempHonor.publicMessage || '';
  ta.addEventListener('input', ()=>{ tempHonor.publicMessage = ta.value; });
  pmMsg.appendChild(ta);
  wrapper.appendChild(pmMsg);

  // parents manager (teacher only)
  const pm = document.createElement('div'); pm.style.marginTop='12px'; pm.innerHTML = '<h3>إدارة أكواد أولياء الأمور (ظاهرة للمعلم فقط)</h3>';
  dashboard.parents = dashboard.parents || [];
  const list = document.createElement('div');
  students.forEach((s,si)=>{
    const row = document.createElement('div'); row.style.display='flex'; row.style.alignItems='center'; row.style.gap='8px'; row.style.marginBottom='6px';
    const label = document.createElement('div'); label.style.minWidth='140px'; label.textContent = s;
    const inputCode = document.createElement('input'); inputCode.placeholder='كود ولي الأمر';
    const existing = dashboard.parents.find(p=>p.childId===si);
    if(existing){ inputCode.value = existing.code; }
    const visitsLabel = document.createElement('div'); visitsLabel.className='small muted'; visitsLabel.style.minWidth='180px';
    if(existing){
      const last = existing.lastVisit ? (new Date(existing.lastVisit)).toLocaleString('ar-SA') : '—';
      visitsLabel.innerHTML = `زيارات: <strong>${existing.visitCount||0}</strong> — آخر زيارة: <strong>${last}</strong>`;
    } else {
      visitsLabel.innerHTML = `زيارات: <strong>0</strong> — آخر: <strong>—</strong>`;
    }

    const btnGen = document.createElement('button'); btnGen.textContent='توليد'; btnGen.onclick = ()=>{ const code = generateParentCode(); inputCode.value = code; };
    const saveBtn = document.createElement('button'); saveBtn.textContent='حفظ'; saveBtn.onclick = ()=>{
      const code = inputCode.value.trim(); if(!code) { alert('أدخل الكود'); return; }
      const prevIdx = dashboard.parents.findIndex(p=>p.childId===si);
      if(prevIdx>=0) dashboard.parents.splice(prevIdx,1);
      dashboard.parents.push({ code, childId: si, parentName: '', visitCount: existing? (existing.visitCount||0) : 0, lastVisit: existing? (existing.lastVisit||'') : '' });
      saveDashboard().then(()=>{ alert('تم حفظ الكود'); renderHonorEditor(); }).catch(err=>{ console.error(err); alert('خطأ أثناء الحفظ'); });
    };
    const delBtn = document.createElement('button'); delBtn.textContent='حذف'; delBtn.onclick = ()=>{ if(!confirm('حذف الكود لهذا الطالب؟')) return; const idx = dashboard.parents.findIndex(p=>p.childId===si); if(idx>=0) dashboard.parents.splice(idx,1); saveDashboard(); renderHonorEditor(); };
    const resetVisitsBtn = document.createElement('button'); resetVisitsBtn.textContent='إعادة عداد الزيارات'; resetVisitsBtn.onclick = ()=>{
      if(!confirm('إعادة تعيين عدد الزيارات لهذا الولي إلى 0؟')) return;
      const idx = dashboard.parents.findIndex(p=>p.childId===si);
      if(idx>=0){ dashboard.parents[idx].visitCount = 0; dashboard.parents[idx].lastVisit = ''; saveDashboard().then(()=>{ renderHonorEditor(); }); }
    };
    row.append(label,inputCode,btnGen,saveBtn,delBtn,visitsLabel,resetVisitsBtn); list.appendChild(row);
  });
  pm.appendChild(list);
  wrapper.appendChild(pm);

  // confirm / cancel buttons for staged honor changes
  const confirmArea = document.createElement('div'); confirmArea.className = 'confirm-area';
  const saveConfirm = document.createElement('button'); saveConfirm.textContent='تأكيد الحفظ'; saveConfirm.className='primary';
  saveConfirm.onclick = ()=>{ if(!confirm('حفظ التغييرات؟')) return; dashboard.honor = deepCopy(tempHonor); saveDashboard().then(()=>{ tempHonor = null; alert('تم حفظ التغييرات'); renderHonorEditor(); renderPublicHonor(); }).catch(err=>{ console.error(err); alert('حدث خطأ أثناء الحفظ'); }); };
  const cancelBtn = document.createElement('button'); cancelBtn.textContent='إلغاء'; cancelBtn.onclick = ()=>{ if(!confirm('إلغاء التغييرات؟')) return; tempHonor = null; renderHonorEditor(); };
  confirmArea.appendChild(saveConfirm); confirmArea.appendChild(cancelBtn);
  wrapper.appendChild(confirmArea);

  honorContent.appendChild(wrapper);
}

/* ---------- Parent code generator ---------- */
function generateParentCode(seed){
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let code=''; for(let i=0;i<6;i++) code += chars[Math.floor(Math.random()*chars.length)];
  if(dashboard.parents.find(p=>p.code===code)) return generateParentCode(seed);
  return code;
}

/* ---------- Supervisor controls ---------- */
function renderSupervisorControls(){
  document.getElementById('supervisorSearchBtn').onclick = ()=>{
    const q = (supervisorSearch.value||'').trim().toLowerCase();
    renderSupervisorDetailed(q);
  };
  supervisorSearch.addEventListener('keyup', (e)=>{ if(e.key === 'Enter') supervisorSearchBtn.click(); });
}

/* ---------- Supervisor detailed view (now shows daily grades neatly) ---------- */
function renderSupervisorDetailed(query=''){
  supervisorContainer.innerHTML = '';
  const container = document.createElement('div'); container.style.padding='8px';

  const studentsFiltered = students.map((s,i)=>({name:s,id:i})).filter(x=> x.name.toLowerCase().includes((query||'').toLowerCase()));
  if(studentsFiltered.length===0){
    container.innerHTML = `<div class="small muted" style="padding:12px">لا يوجد طلاب مطابقون للبحث.</div>`;
    supervisorContainer.appendChild(container);
    return;
  }

  studentsFiltered.forEach(st=>{
    const card = document.createElement('div'); card.style.border='1px solid var(--border)'; card.style.borderRadius='10px'; card.style.padding='12px'; card.style.marginBottom='10px'; card.style.background='#fff';
    const header = document.createElement('div'); header.style.display='flex'; header.style.justifyContent='space-between'; header.style.alignItems='center';
    header.innerHTML = `<div><strong>${escapeHtml(st.name)}</strong></div><div class="small muted">ID:${st.id}</div>`;
    card.appendChild(header);

    // tests
    const testsDiv = document.createElement('div'); testsDiv.style.marginTop='8px';
    testsDiv.innerHTML = '<strong>الاختبارات</strong>';
    const testsList = document.createElement('div'); testsList.style.marginTop='6px';
    if(!dashboard.tests || !dashboard.tests.exams || dashboard.tests.exams.length===0) testsList.innerHTML = '<div class="small muted">لا توجد اختبارات</div>';
    else {
      dashboard.tests.exams.forEach(ex=>{
        const stScore = (dashboard.tests.scores && dashboard.tests.scores[st.id] && dashboard.tests.scores[st.id].grades && dashboard.tests.scores[st.id].grades[ex] !== undefined) ? dashboard.tests.scores[st.id].grades[ex] : '—';
        testsList.innerHTML += `<div style="display:flex;justify-content:space-between;gap:12px"><div>${escapeHtml(ex)}</div><div><strong>${escapeHtml(String(stScore))}</strong></div></div>`;
      });
    }
    testsDiv.appendChild(testsList); card.appendChild(testsDiv);

    // daily grades table (neat)
    const dailyDiv = document.createElement('div'); dailyDiv.style.marginTop='8px';
    dailyDiv.innerHTML = '<strong>درجات يومية (حفظ - تثبيت - مراجعة - سلوك)</strong>';
    const t = document.createElement('table');
    t.innerHTML = '<tr><th>الأسبوع</th><th>اليوم</th><th>التاريخ</th><th>غياب</th><th>حفظ</th><th>تثبيت</th><th>مراجعة</th><th>سلوك</th></tr>';
    dashboard.weeks.forEach((w,wi)=>{
      w.days.forEach((d,di)=>{
        const r = d.rows[st.id] || {};
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(w.title)}</td><td>${escapeHtml(d.title)}</td><td>${escapeHtml(d.date||'')}</td><td>${escapeHtml(absenceLabel(r.absence))}</td>
          <td>${escapeHtml(String(tokenToNumber(r['حفظ'])||''))}</td><td>${escapeHtml(String(tokenToNumber(r['تثبيت'])||''))}</td><td>${escapeHtml(String(tokenToNumber(r['مراجعة'])||''))}</td><td>${escapeHtml(String(tokenToNumber(r['سلوك'])||''))}</td>`;
        t.appendChild(tr);
      });
    });
    dailyDiv.appendChild(t);
    card.appendChild(dailyDiv);

    // weekly progress summary (compact)
    const weeksDiv = document.createElement('div'); weeksDiv.style.marginTop='8px';
    weeksDiv.innerHTML = '<strong>التقدّم الأسبوعي</strong>';
    dashboard.weeks.forEach((w,wi)=>{
      if(!w.aiProgress || !w.aiProgress.percents) computeAiWeightedProgressForWeek(wi,{save:false});
      const pct = w.aiProgress && typeof w.aiProgress.percents[st.id] !== 'undefined' ? Math.round(w.aiProgress.percents[st.id]) : 0;
      const prev = (wi>0 && dashboard.weeks[wi-1] && dashboard.weeks[wi-1].aiProgress && typeof dashboard.weeks[wi-1].aiProgress.percents[st.id] !== 'undefined') ? Math.round(dashboard.weeks[wi-1].aiProgress.percents[st.id]) : 0;
      const line = document.createElement('div'); line.style.display='flex'; line.style.justifyContent='space-between'; line.style.alignItems='center'; line.style.marginTop='6px';
      line.innerHTML = `<div style="min-width:160px">${escapeHtml(w.title||('الأسبوع '+(wi+1)))}</div><div style="width:240px">${renderInlineProgressBar(pct, w.aiProgress && w.aiProgress.messages && w.aiProgress.messages[st.id] ? w.aiProgress.messages[st.id] : '')}${renderComparisonBar(pct, prev)}</div>`;
      weeksDiv.appendChild(line);
    });
    card.appendChild(weeksDiv);

    container.appendChild(card);
  });

  supervisorContainer.appendChild(container);
}

/* ---------- Tests page (staged save with confirm) ---------- */
function renderTestsPage(){
  testsContainer.innerHTML = '';
  if(!dashboard) dashboard = createDefault();
  if(!dashboard.tests) dashboard.tests = { exams:[], scores: students.map((s,i)=>({id:i,name:s,grades:{}})) };
  if(!Array.isArray(dashboard.tests.exams)) dashboard.tests.exams = [];
  if(!Array.isArray(dashboard.tests.scores) || dashboard.tests.scores.length !== students.length) dashboard.tests.scores = students.map((s,i)=>({id:i,name:s,grades:{}}));
  const wrapper = document.createElement('div');

  if(dashboard.tests.exams.length===0){
    const p=document.createElement('p'); p.className='muted'; p.textContent='لا توجد اختبارات مضافة';
    wrapper.appendChild(p);
  } else {
    const table=document.createElement('table'); table.style.tableLayout='fixed';
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    const thName = document.createElement('th'); thName.textContent = 'الطالب'; headerRow.appendChild(thName);

    // build exam headers with delete button for teacher
    dashboard.tests.exams.forEach(ex=>{
      const th = document.createElement('th'); th.style.minWidth='120px';
      const container = document.createElement('div'); container.style.display='flex'; container.style.justifyContent='space-between'; container.style.alignItems='center';
      const span = document.createElement('div'); span.textContent = ex; container.appendChild(span);
      if(role === 'teacher'){
        const delBtn = document.createElement('button'); delBtn.className='inline-btn'; delBtn.textContent='حذف';
        delBtn.addEventListener('click', ()=>{ if(!confirm('حذف الاختبار "'+ex+'"؟')) return; deleteExam(ex); });
        container.appendChild(delBtn);
      }
      th.appendChild(container);
      headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    table.appendChild(thead);

    const tbody=document.createElement('tbody');
    dashboard.tests.scores.forEach(st=>{
      const tr=document.createElement('tr');
      const tdName = document.createElement('td'); tdName.style.textAlign = 'right'; tdName.style.paddingRight = '8px'; tdName.textContent = st.name; tr.appendChild(tdName);

      dashboard.tests.exams.forEach(ex=>{
        const td=document.createElement('td');
        const inp = document.createElement('input'); inp.style.width='100%';
        inp.value = (st.grades && st.grades[ex] !== undefined) ? st.grades[ex] : '';
        // update model on input but DO NOT save to Firebase until confirm
        inp.addEventListener('input', ()=>{ if(!st.grades) st.grades = {}; st.grades[ex] = inp.value.trim()===''? '' : (isNaN(Number(inp.value.trim())) ? inp.value.trim() : Number(inp.value.trim())); testsDirty = true; showTestsSaveUI(); });
        // allow Enter to blur (no auto-save)
        inp.addEventListener('keydown', (e)=>{ if(e.key === 'Enter'){ e.preventDefault(); inp.blur(); } });
        if(role !== 'teacher') inp.disabled = true;
        td.appendChild(inp);
        tr.appendChild(td);
      });

      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    wrapper.appendChild(table);
  }

  testsContainer.appendChild(wrapper);

  // buttons behavior
  if(testsAddBtn){
    testsAddBtn.style.display = (role==='teacher' ? 'inline-block' : 'none');
    testsAddBtn.onclick = function(){
      if(role!=='teacher') return alert('غير مصرح');
      const name = prompt('اسم الاختبار:');
      if(!name) return;
      if(!dashboard.tests) dashboard.tests={exams:[],scores: students.map((s,i)=>({id:i,name:s,grades:{}}))};
      if(dashboard.tests.exams.includes(name)){ alert('الاختبار موجود'); return; }
      dashboard.tests.exams.push(name);
      dashboard.tests.scores.forEach(st=>{ if(!st.grades) st.grades = {}; st.grades[name]=''; });
      // mark dirty so teacher confirms save
      testsDirty = true; showTestsSaveUI();
      renderTestsPage();
    };
  }
  if(testsBackupBtn){
    testsBackupBtn.style.display = (role==='teacher' ? 'inline-block' : 'none');
    testsBackupBtn.onclick = function(){
      if(role!=='teacher') return alert('غير مصرح');
      downloadBackup();
    };
  }
  // save confirm button
  if(testsSaveBtn){
    testsSaveBtn.style.display = (testsDirty && role==='teacher') ? 'inline-block' : 'none';
    testsSaveBtn.onclick = function(){
      if(role!=='teacher') return alert('غير مصرح');
      saveDashboard().then(()=>{ testsDirty = false; showTestsSaveUI(); alert('تم حفظ درجات الاختبارات'); renderTestsPage(); }).catch(err=>{ console.error(err); alert('حدث خطأ أثناء الحفظ'); });
    };
  }
}

function showTestsSaveUI(){ if(testsSaveBtn) testsSaveBtn.style.display = (testsDirty && role==='teacher') ? 'inline-block' : 'none'; }

/* ---------- deleteExam function (global) ---------- */
window.deleteExam = function(ex){
  if(role!=='teacher') return alert('غير مصرح');
  if(!confirm('حذف الاختبار "'+ex+'"؟')) return;
  dashboard.tests.exams = dashboard.tests.exams.filter(e=>e!==ex);
  dashboard.tests.scores.forEach(s=>{ if(s.grades) delete s.grades[ex]; });
  saveDashboard().then(()=>{ renderTestsPage(); }).catch(err=>{ console.error(err); renderTestsPage(); });
};

/* ---------- backup download ---------- */
function downloadBackup(){
  const dataStr = JSON.stringify(dashboard, null, 2);
  const blob = new Blob([dataStr], { type: 'application/json' });
  const now = new Date();
  const name = `dashboard-backup-${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}-${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}.json`;
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = name; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

/* ---------- Stats page (with nominated >=90%) ---------- */
function renderStatsPage(){
  statsContent.innerHTML = '';
  // attendance stats
  const table=document.createElement('table');
  table.innerHTML = '<tr><th>الطالب</th><th>غائب بعذر</th><th>غائب بدون</th><th>تأخير</th></tr>';
  const tbody=document.createElement('tbody');
  const counts = students.map(()=>({excused:0,unexcused:0,late:0}));
  dashboard.weeks.forEach(week=>{
    week.days.forEach(day=>{
      day.rows.forEach(r=>{
        if(r.absence==='excused') counts[r.id].excused++;
        if(r.absence==='unexcused') counts[r.id].unexcused++;
        if(r.absence==='late') counts[r.id].late++;
      });
    });
  });
  students.forEach((s,i)=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${escapeHtml(s)}</td><td>${counts[i].excused}</td><td>${counts[i].unexcused}</td><td>${counts[i].late}</td>`; tbody.appendChild(tr); });
  table.appendChild(tbody);
  statsContent.appendChild(table);

  if(role!=='teacher') return;
  dashboard.weeks.forEach((w,wi)=>{ if(!w.aiProgress || !w.aiProgress.percents) computeAiWeightedProgressForWeek(wi,{save:false}); });

  const ranksTable = document.createElement('table');
  let hdr = '<tr><th>الطالب</th>';
  dashboard.weeks.forEach(w=>{ hdr += `<th>${escapeHtml(w.title || 'أسبوع')}</th>`; });
  hdr += '<th>ملاحظة</th></tr>'; ranksTable.innerHTML = hdr;
  const tbRanks = document.createElement('tbody');

  for(let si=0; si<students.length; si++){
    let rowHtml = `<tr><td>${escapeHtml(students[si])}</td>`;
    dashboard.weeks.forEach((w,wi)=>{
      const ranks = computeWeekRanks(wi);
      const cell = (ranks && ranks[si]) ? ranks[si] : '—';
      rowHtml += `<td>${cell}</td>`;
    });
    rowHtml += `<td class="small muted">-</td></tr>`;
    tbRanks.insertAdjacentHTML('beforeend', rowHtml);
  }
  ranksTable.appendChild(tbRanks);
  ranksTable.style.marginTop = '12px';
  statsContent.appendChild(ranksTable);

  // nominated per week (>=90%)
  const nominatedWrap = document.createElement('div'); nominatedWrap.style.marginTop='12px';
  nominatedWrap.innerHTML = '<h3>المرشّحون للتكريم (نسبة ≥ 90%) لكل أسبوع</h3>';
  dashboard.weeks.forEach((w,wi)=>{
    const div = document.createElement('div'); div.className='week-progress-row';
    const label = document.createElement('div'); label.className='label'; label.textContent = w.title || ('الأسبوع '+(wi+1));
    const list = document.createElement('div'); list.style.textAlign='right';
    if(!w.aiProgress || !w.aiProgress.percents) computeAiWeightedProgressForWeek(wi,{save:false});
    const noms = [];
    w.aiProgress.percents.forEach((p,si)=>{ if(p>=90) noms.push({ id:si, pct:p }); });
    if(noms.length===0) list.innerHTML = '<span class="small muted">لا مرشحين</span>';
    else {
      list.innerHTML = noms.map(n=>`${escapeHtml(students[n.id])} — ${n.pct}%`).join(' • ');
    }
    div.appendChild(label); div.appendChild(list); nominatedWrap.appendChild(div);
  });
  statsContent.appendChild(nominatedWrap);
}

/* ---------- weeks rendering + approval button ---------- */
function renderWeeks(){ weeksBox.innerHTML=''; dashboard.weeks.forEach((w,idx)=>{ const b=document.createElement('button'); b.className='week-btn '+(idx===currentWeek?'active':'');
  const titleDiv = document.createElement('div'); titleDiv.textContent = w.title||`الأسبوع ${idx+1}`;
  b.appendChild(titleDiv);

  const complete = isWeekComplete(w);
  if(complete || w.approved){ if(!w.aiProgress || !w.aiProgress.percents) computeAiWeightedProgressForWeek(idx, { save:false }); const avg = Math.round(w.aiProgress.percents.reduce((a,b)=>a+b,0)/w.aiProgress.percents.length); const progDiv = document.createElement('div'); progDiv.style.marginTop='6px'; progDiv.style.width='120px'; progDiv.innerHTML = renderInlineProgressBar(avg, avg<80? 'يحتاج متابعة' : (avg<=90? 'جيد' : 'ممتاز واصل يا بطل')); b.appendChild(progDiv); }
  const appr = document.createElement('div'); appr.style.marginTop='6px'; appr.innerHTML = w.approved ? `<span class="small" style="color:var(--accent)">✅ معتمد</span>` : `<span class="small muted">غير معتمد</span>`;
  b.appendChild(appr);

  const approveBtn = document.createElement('button'); approveBtn.className='inline-btn teacher-only'; approveBtn.textContent = w.approved ? 'سحب الاعتماد' : 'اعتماد التقدم';
  approveBtn.style.marginTop='6px';
  approveBtn.onclick = (e)=>{ e.stopPropagation(); if(role!=='teacher') return; if(!confirm((w.approved? 'سحب اعتماد الأسبوع؟' : 'اعتماد التقدم لهذا الأسبوع؟'))) return; dashboard.weeks[idx].approved = !dashboard.weeks[idx].approved; saveDashboard(); renderWeeks(); renderGrid(); };
  b.appendChild(approveBtn);

  b.onclick=()=>{ currentWeek=idx; currentDay=0; renderGrid(); };
  weeksBox.appendChild(b); }); }

if(addWeekBtn){
  addWeekBtn.addEventListener('click', ()=>{
    if(role!=='teacher') return alert('غير مصرح');
    const name = prompt('اسم الأسبوع:', `الأسبوع ${dashboard.weeks.length+1}`);
    if(name===null) return;
    const days = defaultDays.map(d=>({ title:d, date:'', rows: students.map((s,i)=>({ id:i,name:s, absence:'present', حفظ:'', تثبيت:'', مراجعة:'', سلوك:'', note:'' })), honorPositions: [] }));
    dashboard.weeks.push({ title: name, days, honorPositions: [], approved: false });
    currentWeek = dashboard.weeks.length - 1;
    saveDashboard().then(()=>{ renderWeeks(); renderGrid(); }).catch(err=>{ console.error(err); renderWeeks(); renderGrid(); });
  });
}
if(delWeekBtn){
  delWeekBtn.addEventListener('click', ()=>{
    if(role!=='teacher') return alert('غير مصرح');
    if(!confirm('هل تريد حذف الأسبوع الحالي؟')) return;
    if(dashboard.weeks.length<=1){ alert('لا يمكن حذف آخر أسبوع'); return; }
    dashboard.weeks.splice(currentWeek,1);
    if(currentWeek > dashboard.weeks.length-1) currentWeek = dashboard.weeks.length-1;
    saveDashboard().then(()=>{ renderWeeks(); renderGrid(); });
  });
}
if(prevWeek){ prevWeek.addEventListener('click', ()=>{ if(currentWeek>0) currentWeek--; renderWeeks(); renderGrid(); }); }
if(nextWeek){ nextWeek.addEventListener('click', ()=>{ if(currentWeek < dashboard.weeks.length-1) currentWeek++; else { const name = `الأسبوع ${dashboard.weeks.length+1}`; const days = defaultDays.map(d=>({ title:d, date:'', rows: students.map((s,i)=>({ id:i,name:s, absence:'present', حفظ:'', تثبيت:'', مراجعة:'', سلوك:'', note:'' })), honorPositions: [] })); dashboard.weeks.push({ title: name, days, honorPositions: [], approved: false }); currentWeek = dashboard.weeks.length-1; saveDashboard(); } renderWeeks(); renderGrid(); }); }

/* ---------- check completeness ---------- */
function isWeekComplete(week){
  if(!week || !Array.isArray(week.days) || week.days.length===0) return false;
  for(const d of week.days){
    if(!d.rows || d.rows.length!==students.length) return false;
    for(const r of d.rows){
      if(!r) return false;
      const fields = ['حفظ','تثبيت','مراجعة','سلوك'];
      for(const f of fields){
        if(!r[f] && r[f] !== 0 && r[f] !== '0') return false;
      }
    }
  }
  return true;
}
function isStudentCompleteInWeek(week, studentIndex){
  if(!week || !Array.isArray(week.days) || week.days.length===0) return false;
  const fields = ['حفظ','تثبيت','مراجعة','سلوك'];
  for(const d of week.days){
    const r = d.rows && d.rows[studentIndex];
    if(!r) return false;
    for(const f of fields){
      if(!r[f] && r[f] !== 0 && r[f] !== '0') return false;
    }
  }
  return true;
}

/* ---------- render grid (teacher) ---------- */
function renderGrid(){
  gridWrap.innerHTML='';
  if(role!=='teacher') return;
  const week = dashboard.weeks[currentWeek];
  if(!week) return;
  computeAiWeightedProgressForWeek(currentWeek, { save:false });
  weekTitle.innerHTML = `<h3 style="margin:6px 0" class="display-font">${escapeHtml(week.title)} — ${escapeHtml(week.days[currentDay].title || ('اليوم '+(currentDay+1)))}</h3>`;
  const anyStudentComplete = students.some((_,si)=> isStudentCompleteInWeek(week, si));
  const table = document.createElement('table');
  const headerCols = `<tr><th>الطالب</th><th>غياب</th><th>حفظ</th><th>تثبيت</th><th>مراجعة</th><th>سلوك</th><th>ملاحظة</th>${anyStudentComplete || week.approved?'<th>تقدم</th>':''}</tr>`;
  const thead = document.createElement('thead'); thead.innerHTML = headerCols; table.appendChild(thead);
  const tbody = document.createElement('tbody');
  week.days[currentDay].rows.forEach((row,si)=>{
    const tr = document.createElement('tr'); if(row.absence==='excused' || row.absence==='unexcused') tr.classList.add('faded'); tr.classList.add('fade');
    if(row.absence === 'late') tr.classList.add('late-row');

    const tdName = document.createElement('td'); tdName.style.textAlign = 'right'; tdName.style.paddingRight = '8px';
    tdName.textContent = row.name;
    if(row.absence === 'late'){ const lateSpan = document.createElement('span'); lateSpan.className = 'late-indicator'; lateSpan.textContent = '⏰ متأخر'; tdName.appendChild(lateSpan); }
    tr.appendChild(tdName);

    const tdAbs = document.createElement('td'); tdAbs.textContent = absenceLabel(row.absence); tdAbs.style.cursor='pointer';
    tdAbs.onclick = ()=>{ if(row.absence==='present' || !row.absence) row.absence='excused'; else if(row.absence==='excused') row.absence='unexcused'; else if(row.absence==='unexcused') row.absence='late'; else row.absence='present'; scheduleSave(); renderGrid(); };
    tr.appendChild(tdAbs);

    const makeScoreCell = (field)=>{ const td=document.createElement('td'); const sel=document.createElement('select'); sel.className='score-select'; const opts=[{v:'3-star',t:'3 ⭐️'},{v:'3-check',t:'3 ✅'},{v:'2',t:'2 ⚠️'},{v:'1',t:'1 ⚠️'},{v:'0',t:'0 ❌'},{v:'',t:'إفراغ'}]; opts.forEach(o=>{ const op=document.createElement('option'); op.value=o.v; op.textContent=o.t; if(row[field]===o.v) op.selected=true; sel.appendChild(op); }); sel.onchange = ()=>{ row[field]=sel.value; scheduleSave(); renderGrid(); }; td.appendChild(sel); return td; };
    tr.appendChild(makeScoreCell('حفظ')); tr.appendChild(makeScoreCell('تثبيت')); tr.appendChild(makeScoreCell('مراجعة')); tr.appendChild(makeScoreCell('سلوك'));

    // note cell with presets (use smaller select and immediate-saving)
    const tdNote = document.createElement('td');
    const ta = document.createElement('textarea'); ta.value=row.note||''; ta.addEventListener('input', ()=>{ row.note=ta.value; scheduleSave(); });
    const selectPreset = document.createElement('select'); selectPreset.className = 'small-select'; selectPreset.style.marginTop='6px'; const defaultOpt = document.createElement('option'); defaultOpt.value=''; defaultOpt.textContent='— اختَر ملاحظة سريعة —'; selectPreset.appendChild(defaultOpt);
    const groupPos = document.createElement('optgroup'); groupPos.label='تحفيزية'; presetNotes.positive.forEach(pn=>{ const o=document.createElement('option'); o.value=pn; o.textContent=pn; groupPos.appendChild(o); });
    const groupWarn = document.createElement('optgroup'); groupWarn.label='تحذيرية'; presetNotes.warning.forEach(pn=>{ const o=document.createElement('option'); o.value=pn; o.textContent=pn; groupWarn.appendChild(o); });
    selectPreset.appendChild(groupPos); selectPreset.appendChild(groupWarn);
    const insertBtn = document.createElement('button'); insertBtn.className='inline-btn'; insertBtn.textContent='إدراج'; insertBtn.onclick=()=>{ if(selectPreset.value){ ta.value = ta.value ? (ta.value + ' • ' + selectPreset.value) : selectPreset.value; row.note = ta.value; scheduleSave(); } };
    tdNote.appendChild(ta); tdNote.appendChild(selectPreset); tdNote.appendChild(insertBtn);
    tr.appendChild(tdNote);

    // progress cell: show if student complete OR week.approved
    if(isStudentCompleteInWeek(week, si) || week.approved){
      const percent = Math.round((week.aiProgress && week.aiProgress.percents) ? week.aiProgress.percents[si] : 0);
      const prev = (currentWeek>0 && dashboard.weeks[currentWeek-1] && dashboard.weeks[currentWeek-1].aiProgress && typeof dashboard.weeks[currentWeek-1].aiProgress.percents[si] !== 'undefined') ? Math.round(dashboard.weeks[currentWeek-1].aiProgress.percents[si]) : 0;
      const msg = (week.aiProgress && week.aiProgress.messages && week.aiProgress.messages[si])? week.aiProgress.messages[si] : '';
      const tdProg = document.createElement('td'); tdProg.innerHTML = renderProgressBarHtml(percent,msg) + renderComparisonBar(percent, prev); tr.appendChild(tdProg);
    } else if(anyStudentComplete){
      const tdEmpty = document.createElement('td'); tdEmpty.innerHTML = '<span class="small muted">غير مكتمل (انتظر اعتماد أو إكمال البيانات)</span>'; tr.appendChild(tdEmpty);
    }
    tbody.appendChild(tr);
  });
  table.appendChild(tbody); gridWrap.appendChild(table);

  // days navigation and edit buttons
  const daysNav = document.createElement('div'); daysNav.className='days-nav';
  dashboard.weeks[currentWeek].days.forEach((d,di)=>{ const b=document.createElement('button'); b.className='week-btn '+(di===currentDay?'active':''); b.textContent=d.title||(`اليوم ${di+1}`); b.onclick=()=>{ currentDay=di; renderGrid(); }; daysNav.appendChild(b); });
  const editDayBtn=document.createElement('button'); editDayBtn.className='inline-btn'; editDayBtn.textContent='تعديل اسم/تاريخ'; editDayBtn.onclick=()=>{ const newT=prompt('اسم اليوم:', dashboard.weeks[currentWeek].days[currentDay].title||('اليوم '+(currentDay+1))); if(newT!==null) dashboard.weeks[currentWeek].days[currentDay].title=newT; const newD=prompt('تاريخ (YYYY-MM-DD):', dashboard.weeks[currentWeek].days[currentDay].date||''); if(newD!==null) dashboard.weeks[currentWeek].days[currentDay].date=newD; scheduleSave(); renderAll(); };
  const addDayBtn=document.createElement('button'); addDayBtn.className='inline-btn'; addDayBtn.textContent='+ يوم'; addDayBtn.onclick=()=>{ const title=prompt('اسم اليوم الجديد:','يوم جديد'); if(title===null) return; const rows = students.map((name,i)=>({ id:i,name, absence:'present', حفظ:'', تثبيت:'', مراجعة:'', سلوك:'', note:'' })); dashboard.weeks[currentWeek].days.push({ title, date:'', rows, honorPositions: [] }); scheduleSave(); renderAll(); };
  daysNav.appendChild(editDayBtn); daysNav.appendChild(addDayBtn); gridWrap.appendChild(daysNav);
}

/* ---------- debounce save ---------- */
let saveTimer = null;
function scheduleSave(delay=700){ if(saveTimer) clearTimeout(saveTimer); saveTimer = setTimeout(()=>{ saveDashboard().catch(err=>console.error('Save failed', err)); saveTimer = null; }, delay); }

/* ---------- Parent inactivity modal (thresholdDays adjustable) ---------- */
function computeInactiveParents(thresholdDays=2){
  const out = [];
  if(!dashboard || !Array.isArray(dashboard.parents)) return out;
  const now = Date.now();
  dashboard.parents.forEach(p=>{
    if(!p) return;
    const last = p.lastVisit ? (new Date(p.lastVisit)).getTime() : 0;
    const days = last ? Math.floor((now - last) / (1000*60*60*24)) : null;
    if(last===0 || days === null || days > thresholdDays){
      out.push({ parent: p, daysSince: days, childId: p.childId });
    }
  });
  return out;
}
function showParentInactivityModalIfNeeded(thresholdDays=2){
  if(!dashboard || !Array.isArray(dashboard.parents)) return;
  if(role !== 'teacher') return; // show modal to teacher only
  const inactive = computeInactiveParents(thresholdDays);
  if(!inactive || inactive.length===0) return;
  const overlay = document.createElement('div'); overlay.className='modal-overlay'; overlay.id='parentInactivityModal';
  const modal = document.createElement('div'); modal.className='modal';
  const title = document.createElement('h3'); title.textContent = `تنبيه: ${inactive.length} ولي أمر غير متابعين منذ ${thresholdDays} يومًا أو أكثر`;
  modal.appendChild(title);
  const list = document.createElement('div'); list.style.maxHeight='300px'; list.style.overflow='auto';
  inactive.forEach(it=>{
    const nm = (students[it.childId] || '—');
    const daysText = it.daysSince === null ? 'لم يزروا قط' : `${it.daysSince} يوم`;
    const lastText = it.parent.lastVisit ? (new Date(it.parent.lastVisit)).toLocaleString('ar-SA') : '—';
    const row = document.createElement('div'); row.className='small muted'; row.style.marginBottom='6px';
    row.innerHTML = `<strong>${escapeHtml(nm)}</strong> — ${escapeHtml(daysText)} — آخر زيارة: ${escapeHtml(lastText)} — كود: <code>${escapeHtml(it.parent.code)}</code>`;
    list.appendChild(row);
  });
  modal.appendChild(list);
  const btns = document.createElement('div'); btns.style.display='flex'; btns.style.justifyContent='flex-end'; btns.style.gap='8px'; btns.style.marginTop='8px';
  const close = document.createElement('button'); close.textContent='اغلاق'; close.onclick = ()=>{ overlay.remove(); };
  const remind = document.createElement('button'); remind.textContent='إرسال تذكير (يدوي)'; remind.className='primary';
  remind.onclick = ()=>{ alert('ميزة إرسال تذكير غير مفعّلة آليًا في هذه النسخة. يمكنك إضافة لوجيك الإشعارات لاحقًا.'); };
  btns.appendChild(remind); btns.appendChild(close);
  modal.appendChild(btns);
  overlay.appendChild(modal);
  modalRoot.appendChild(overlay);
}

/* ---------- Manage students page (add/remove) ---------- */
function renderManagePage(){
  manageList.innerHTML = '';
  students.forEach((s,si)=>{
    const row = document.createElement('div'); row.className='manage-row';
    const label = document.createElement('div'); label.style.flex='1'; label.innerHTML = `<strong>${escapeHtml(s)}</strong> <div class="small muted">ID: ${si}</div>`;
    const del = document.createElement('button'); del.className='danger'; del.textContent='حذف'; del.onclick = ()=>{ if(!confirm('حذف الطالب "'+s+'"? سيتم ازالته من كل الأسابيع والاختبارات.')) return; removeStudent(si); };
    row.appendChild(label); row.appendChild(del);
    manageList.appendChild(row);
  });
}
addStudentBtn.addEventListener('click', ()=>{
  const n = (newStudentName.value||'').trim();
  if(!n) return alert('ادخل اسم الطالب');
  addStudent(n);
  newStudentName.value='';
});

/* ---------- addStudent / removeStudent ---------- */
function addStudent(name){
  students.push(name);
  dashboard.weeks.forEach(w=>{ w.days.forEach(d=>{ d.rows.push({ id: students.length-1, name, absence:'present', حفظ:'', تثبيت:'', مراجعة:'', سلوك:'', note:'' }); }); });
  if(!dashboard.tests) dashboard.tests = { exams:[], scores: [] };
  dashboard.tests.scores.push({ id: students.length-1, name, grades:{} });
  saveDashboard().then(()=>{ ensureStructure(); renderManagePage(); renderWeeks(); renderGrid(); alert('تم إضافة الطالب'); });
}
function removeStudent(index){
  const removed = students.splice(index,1)[0];
  dashboard.weeks.forEach(w=>{ w.days.forEach(d=>{ d.rows.splice(index,1); d.rows = d.rows.map((r,i)=>({ ...r, id:i, name: students[i] || r.name })); }); });
  if(dashboard.tests && Array.isArray(dashboard.tests.scores)){ dashboard.tests.scores.splice(index,1); dashboard.tests.scores = dashboard.tests.scores.map((s,i)=>({ id:i, name: students[i] })); }
  if(Array.isArray(dashboard.parents)){ dashboard.parents = dashboard.parents.filter(p=> p.childId !== index); dashboard.parents.forEach(p=>{ if(p.childId > index) p.childId = p.childId - 1; }); }
  if(dashboard.honor && Array.isArray(dashboard.honor.positions)){ dashboard.honor.positions.forEach(pos=>{ if(pos.studentId === index) pos.studentId = null; else if(pos.studentId > index) pos.studentId = pos.studentId - 1; }); }
  saveDashboard().then(()=>{ ensureStructure(); renderManagePage(); renderWeeks(); renderGrid(); alert('تم حذف الطالب: '+removed); });
}

/* ---------- render visitor (parent) result ---------- */
function renderVisitorResult(studentId){
  visitorResult.innerHTML = '';
  visitorResult.setAttribute('data-student-id', String(studentId));
  const header = document.createElement('h3'); header.textContent = `عرض ولي الأمر — ${students[studentId]}`; visitorResult.appendChild(header);

  // Recommendation message if >2 days since last visit
  const p = dashboard.parents && dashboard.parents.find(px=>px.childId===studentId);
  const daysSince = p && p.lastVisit ? Math.floor((Date.now() - new Date(p.lastVisit)) / (1000*60*60*24)) : null;
  if(daysSince !== null && daysSince > 2){
    const rec = document.createElement('div'); rec.className='rec-box'; rec.innerHTML = `مرّت ${daysSince} أيام منذ آخر زيارة. ننصح بالدخول ومتابعة تقدم ابنك بانتظام.`;
    visitorResult.appendChild(rec);
  }

  // show weekly tables — each أسبوع جدول كامل (يشبه اكسل)
  dashboard.weeks.forEach((w,wi)=>{
    if(!w.aiProgress || !w.aiProgress.percents) computeAiWeightedProgressForWeek(wi,{save:false});
    const wrap = document.createElement('div'); wrap.className='visitor-week';
    const titleRow = document.createElement('div'); titleRow.className='week-title';
    titleRow.innerHTML = `<div style="font-weight:700">${escapeHtml(w.title || ('الأسبوع '+(wi+1)))}</div><div class="small muted">نسبة هذا الأسبوع: <strong>${Math.round(w.aiProgress.percents[studentId]||0)}%</strong></div>`;
    wrap.appendChild(titleRow);

    const t = document.createElement('table'); t.className='visitor-table';
    t.innerHTML = `<tr><th style="width:14%">اليوم</th><th style="width:12%">التاريخ</th><th style="width:12%">غياب</th><th style="width:10%">حفظ</th><th style="width:10%">تثبيت</th><th style="width:10%">مراجعة</th><th style="width:10%">سلوك</th><th style="width:22%">ملاحظة</th></tr>`;
    w.days.forEach((d,di)=>{
      const r = d.rows.find(rr=>rr.id===studentId) || {};
      const tr = document.createElement('tr');
      if(r.absence === 'late') tr.classList.add('late-row');
      tr.innerHTML = `<td style="text-align:right;padding-right:8px">${escapeHtml(d.title)}</td><td>${escapeHtml(d.date||'')}</td><td>${escapeHtml(absenceLabel(r.absence))}</td>
        <td>${escapeHtml(displayScoreForParent(r['حفظ']))}</td><td>${escapeHtml(displayScoreForParent(r['تثبيت']))}</td><td>${escapeHtml(displayScoreForParent(r['مراجعة']))}</td><td>${escapeHtml(displayScoreForParent(r['سلوك']))}</td><td style="text-align:right;padding-right:8px">${escapeHtml(r.note||'')}</td>`;
      t.appendChild(tr);
    });
    wrap.appendChild(t);

    // progress + comparison under the table for this week (visible to parent)
    // Show progress only if week is approved OR the week's data is complete
    const showProgress = (w.approved === true) || isWeekComplete(w);
    if(showProgress){
      const pct = Math.round((w.aiProgress && w.aiProgress.percents && typeof w.aiProgress.percents[studentId] !== 'undefined') ? w.aiProgress.percents[studentId] : 0);
      const prev = (wi>0 && dashboard.weeks[wi-1] && dashboard.weeks[wi-1].aiProgress && typeof dashboard.weeks[wi-1].aiProgress.percents[studentId] !== 'undefined') ? Math.round(dashboard.weeks[wi-1].aiProgress.percents[studentId]) : 0;
      const msg = (w.aiProgress && w.aiProgress.messages && w.aiProgress.messages[studentId]) ? w.aiProgress.messages[studentId] : '';
      const progDiv = document.createElement('div'); progDiv.style.marginTop='8px'; progDiv.innerHTML = `<div style="font-weight:700">نسبة التقدّم: ${pct}%</div>${renderProgressBarHtml(pct,msg)}${renderComparisonBar(pct, prev)}`;
      wrap.appendChild(progDiv);
    } else {
      const info = document.createElement('div'); info.className = 'small muted'; info.style.marginTop='8px'; info.textContent = 'لم يتم العرض لأن الأسبوع غير معتمد أو لم تكتمل بيانات الأسبوع.';
      wrap.appendChild(info);
    }

    // center/position for child this week (visible to parent)
    let centerLabel = '—';
    if(Array.isArray(w.honorPositions) && w.honorPositions.length){
      const found = w.honorPositions.find(p=>p.studentId===studentId);
      if(found) centerLabel = found.title || 'مركز';
    } else {
      const comp = computeProgressForWeek(wi,{save:false});
      if(comp){
        const sorted = comp.totals.map((t,i)=>({id:i,total:t,percent: Math.round(comp.percents[i])})).sort((a,b)=>b.total - a.total);
        const idx = sorted.findIndex(s=>s.id===studentId);
        if(idx>=0){
        try{
          const ranks = (typeof computeWeekRanks === 'function') ? computeWeekRanks(wi) : null;
          if(ranks && typeof ranks[studentId] !== 'undefined' && ranks[studentId] !== null){
            centerLabel = `الترتيب ${ranks[studentId]}`;
          } else {
            centerLabel = `الترتيب ${idx+1}`;
          }
        }catch(e){ centerLabel = `الترتيب ${idx+1}`; }
      }
      }
    }
    const centerDiv = document.createElement('div'); centerDiv.style.marginTop='6px'; centerDiv.className='small muted'; centerDiv.innerHTML = `مركز الابن هذا الأسبوع: <strong>${escapeHtml(String(centerLabel))}</strong>`;
    wrap.appendChild(centerDiv);

    visitorResult.appendChild(wrap);
  });

  // tests (visible to parent)
  const testsDiv = document.createElement('div'); testsDiv.style.marginTop='8px'; testsDiv.innerHTML = '<h3>الاختبارات</h3>';
  if(!dashboard.tests || !dashboard.tests.exams || dashboard.tests.exams.length===0){ testsDiv.innerHTML += '<p class="muted">لا توجد اختبارات</p>'; visitorResult.appendChild(testsDiv); return; }
  const tableTests = document.createElement('table'); tableTests.innerHTML = '<tr><th>الاختبار</th><th>الدرجة</th></tr>';
  const st = dashboard.tests.scores.find(s=>s.id===studentId);
  dashboard.tests.exams.forEach(ex=>{ const tr = document.createElement('tr'); tr.innerHTML = `<td>${escapeHtml(ex)}</td><td>${ (st && st.grades && st.grades[ex] !== undefined) ? escapeHtml(String(st.grades[ex])) : '' }</td>`; tableTests.appendChild(tr); });
  testsDiv.appendChild(tableTests); visitorResult.appendChild(testsDiv);
}

/* ---------- ensure all weeks computed ---------- */
function computeAllWeeksIfMissing(){
  if(!dashboard || !Array.isArray(dashboard.weeks)) return;
  dashboard.weeks.forEach((w,wi)=>{ if(!w.aiProgress || !Array.isArray(w.aiProgress.percents)) computeAiWeightedProgressForWeek(wi, { save:false }); });
}

/* ---------- persist unsaved changes on unload ---------- */
window.addEventListener('beforeunload', (e)=>{
  if(saveTimer){ clearTimeout(saveTimer); saveTimer = null; saveDashboard().catch(()=>{}); }
});

/* ---------- initial load ---------- */
loadDashboard().then(()=>{ computeAllWeeksIfMissing(); renderAll(); applyVisitorModeIfNeeded(); });

</script>
</body>
</html>
