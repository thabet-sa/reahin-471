<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>مسابقة صف خامس — لوحة المتابعة (مع تقدم أسبوعي)</title>
<style>
  :root{ --bg:#0f172a; --panel:#0b1220; --muted:#94a3b8; --accent:#7c3aed; --border:#1e293b; --good:#d4b106; --bad:#c02b2b; --excellent:#16a34a; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:#e6eef8;font-family:Tahoma,Arial}
  .app{max-width:1200px;margin:12px auto;padding:12px}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
  .title-block{display:flex;flex-direction:column;align-items:flex-end}
  .title-main{font-weight:800;font-size:20px;margin:0}
  .title-sub{font-size:12px;color:var(--muted);margin-top:2px}
  button{background:var(--panel);color:#fff;padding:10px 12px;border:0;border-radius:10px;cursor:pointer}
  button.primary{background:var(--accent)}
  input,select,textarea{font-size:14px}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border:1px solid var(--border);padding:8px;text-align:center;vertical-align:middle}
  th{background:var(--panel)}
  textarea{width:100%;min-height:48px;padding:8px;border-radius:8px;background:#061025;color:#e6eef8;border:1px solid #123}
  input,select{padding:10px;border-radius:10px;border:1px solid var(--border);background:var(--panel);color:#e6eef8}
  .nav{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}
  .nav button{background:transparent;border:1px solid transparent;color:var(--muted);padding:8px 12px;border-radius:10px}
  .nav button.active{background:var(--accent);color:#fff;border-color:var(--accent)}
  .center{display:flex;justify-content:center;align-items:center}
  .center-col{display:flex;flex-direction:column;align-items:center}
  .center-input{width:360px;border-radius:12px;padding:10px;border:1px solid var(--border);background:var(--panel);text-align:center}
  .honor{background:#071033;padding:12px;border-radius:8px;margin-top:12px}
  .week-btn{padding:8px 12px;border-radius:10px;background:var(--panel);border:1px solid var(--border);cursor:pointer;color:var(--muted);display:flex;flex-direction:column;align-items:center}
  .week-btn.active{background:var(--accent);color:#fff;border-color:var(--accent)}
  .muted{color:var(--muted)}
  .small{font-size:12px;color:var(--muted)}
  .inline-btn{padding:8px 10px;border-radius:10px;background:transparent;border:1px solid var(--border);cursor:pointer;color:var(--muted)}
  .danger{background:#7c1f1f}
  .fade{transition:opacity .18s ease, transform .18s ease}
  tr.faded { opacity: 0.45; }
  td[contenteditable] { outline: none; background: rgba(255,255,255,0.02); }
  select.score-select { padding:8px 10px; border-radius:8px; background:var(--panel); color:#e6eef8 }
  .grid-wrap{overflow:auto;max-height:62vh}
  .progress-wrap{width:140px;margin:auto}
  .progress-bar{height:14px;border-radius:10px;background:#072035;overflow:hidden;border:1px solid #123}
  .progress-fill{height:100%;width:0%;background:var(--excellent);transition:width .5s ease}
  .badge{display:inline-block;padding:4px 8px;border-radius:8px;font-size:13px;margin-right:6px}
  .badge.warn{background:var(--good);color:#111}
  .badge.bad{background:var(--bad);color:#fff}
  .badge.ok{background:#265bff;color:#fff}
  .grid-scroll{overflow:auto;-webkit-overflow-scrolling:touch}
  .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:9999}
  .modal{background:var(--panel);padding:12px;border-radius:10px;max-width:520px;width:92%}
  .modal h3{margin-top:0}
  .hidden{display:none}
  @media (max-width:900px){
    header{flex-direction:column;align-items:stretch}
    .center-input{width:92%}
    .nav{display:none}
    button{width:100%}
    .progress-wrap{width:110px}
  }

  /* safety: don't show teacher-only controls inside visitor area */
  #visitorArea .teacher-only, #visitorArea .week-btn, #visitorArea .inline-btn, #visitorArea .danger { display:none !important; }
  /* but we'll show a public progress list for parents */
  
  .week-progress-row{display:flex;justify-content:space-between;align-items:center;padding:6px;border-radius:8px;background:#06122a;margin-bottom:6px}
  .week-progress-row .label{font-weight:700}
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
  <div class="app">
    <header>
      <div class="title-block">
        <div class="title-main">مسابقة صف خامس</div>
        <div class="title-sub">أ.ثابت الطواله</div>
      </div>

      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <input id="codeInput" type="password" placeholder="ادخل الرمز(خاص بالمعلم)" style="padding:10px;border-radius:10px;background:#0b1220;border:1px solid #1e293b;color:#e6eef8">
        <button id="enterBtn" class="primary">دخول</button>
        <button id="logoutBtn" style="display:none">خروج</button>
      </div>
    </header>

    <div class="nav" id="mainNav" style="display:none">
      <button id="tabHome" class="active">الرئيسية</button>
      <button id="tabTests">الاختبارات</button>
      <button id="tabHonor">لوحة الشرف</button>
      <button id="tabStats">إحصائيات</button>
      <button id="tabSupervisor">عرض المشرف</button>
    </div>

    <!-- Visitor -->
    <div id="visitorArea" class="center-col" style="gap:12px;margin-top:12px">
      <div class="center-col" style="width:100%;align-items:center">
        <input id="visitorInput" class="center-input" placeholder="ادخل اسم الطالب">
        <div style="margin-top:10px;display:flex;gap:8px;width:92%;max-width:760px">
          <button id="visitorShow" class="primary" style="flex:1">عرض</button>
          <button id="visitorClear" style="flex:1">مسح</button>
        </div>
      </div>

      <div id="publicHonor" class="honor" style="width:100%;max-width:920px">
        <h3 style="margin:6px 0">لوحة الشرف الأسبوعية</h3>
        <div id="publicHonorList" class="small">تحميل...</div>
      </div>

      

      <div id="visitorResult" style="width:100%;max-width:1100px;margin-top:12px"></div>
    </div>

    <!-- Teacher main UI (home) -->
    <div id="appUI" class="hidden" style="margin-top:12px">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <div id="weeksBox" style="display:flex;gap:8px;flex-wrap:wrap"></div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <button id="prevWeek" class="inline-btn">◀</button>
          <button id="nextWeek" class="inline-btn">▶</button>
          <button id="addWeek" class="week-btn teacher-only">+ أضف أسبوع</button>
          <button id="delWeek" class="week-btn danger teacher-only">حذف الأسبوع</button>
          <button id="suggestRankBtn" class="week-btn teacher-only primary">اقتراح ترتيب آلي</button>
        </div>
      </div>

      <div id="weekTitle" style="margin-top:10px"></div>
      <div class="grid-wrap grid-scroll" id="gridWrap" style="margin-top:12px"></div>
    </div>

    <!-- Tests page -->
    <section id="testsPage" class="hidden" style="margin-top:12px">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
        <h2>صفحة الاختبارات</h2>
        <div style="display:flex;gap:8px">
          <button id="testsAddBtn" class="primary teacher-only">+ أضف اختبار</button>
        </div>
      </div>
      <div id="testsContainer" style="margin-top:10px"></div>
    </section>

    <!-- Honor editor page (manual) -->
    <section id="honorPage" class="hidden" style="margin-top:12px">
      <h2>لوحة الشرف</h2>
      <div id="honorContent" class="honor" style="margin-top:8px"></div>
    </section>

    <!-- Stats page -->
    <section id="statsPage" class="hidden" style="margin-top:12px">
      <h2>إحصائيات الحضور والتأخير</h2>
      <div id="statsContent" style="margin-top:8px"></div>
    </section>

    <!-- Supervisor-only panel -->
    <div id="supervisorOnly" class="hidden" style="margin-top:12px">
      <h2 style="text-align:center">عرض المشرف</h2>
      <div id="supervisorContainer" class="grid-wrap grid-scroll" style="margin-top:12px"></div>
    </div>
  </div>

<script>
/* ---------------- Firebase config ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyBtRfu6QqoJFO8LpP8KjC4UNO7osnae3c8",
  authDomain: "riahen-5.firebaseapp.com",
  databaseURL: "https://riahen-5-default-rtdb.firebaseio.com",
  projectId: "riahen-5",
  storageBucket: "riahen-5.firebasestorage.app",
  messagingSenderId: "492417113789",
  appId: "1:492417113789:web:3629c70fe7b50c403c21d4",
  measurementId: "G-TRGSYPBV1F"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ---------------- Data & defaults ---------------- */
const students = [
  'سعود الرومي','سعد الفريح','فارس البداح','عبدالرحمن القشعمي',
  'تميم الرميح','عبدالحكيم الحمد','حسام الطريقي','هشام الفايز',
  'عبدالرحمن الفرهود','ابراهيم المتعب','سليمان الفرهود','سليمان القشعمي','سليمان الدويش'
];
const defaultDays = ['الأحد','الإثنين','الثلاثاء','الأربعاء','الخميس'];

let dashboard = null;
let role = 'visitor'; // visitor | teacher | supervisor
let currentWeek = 0;
let currentDay = 0;
let currentTab = 'home';

/* ---------- helpers ---------- */
function tokenToNumber(token){
  if(!token && token!=='0') return 0;
  if(token==='3-star' || token==='3-check') return 3;
  if(token==='2') return 2;
  if(token==='1') return 1;
  if(token==='0') return 0;
  const n = Number(token);
  return isNaN(n)?0:n;
}
function tokenToEmoji(token){
  if(!token && token!=='0') return '';
  if(token==='3-star') return '⭐️';
  if(token==='3-check') return '✅';
  if(token==='2') return '⚠️';
  if(token==='1') return '⚠️';
  if(token==='0') return '❌';
  return token;
}
function absenceLabel(a){
  if(!a || a==='present') return 'حاضر';
  if(a==='excused') return 'غائب بعذر';
  if(a==='unexcused') return 'غائب بدون';
  if(a==='late') return 'متأخر';
  return a;
}

/* ---------- DB load/save ---------- */
async function loadDashboard(){
  const snap = await db.ref('dashboard').get();
  if(snap.exists()){ dashboard = snap.val(); ensureStructure(); }
  else { dashboard = createDefault(); await saveDashboard(); }
  // sync live
  db.ref('dashboard').on('value', s=>{ if(s.exists()){ dashboard = s.val(); ensureStructure(); renderAll(); applyVisitorModeIfNeeded(); }});
  renderAll();
  applyVisitorModeIfNeeded();
}
function saveDashboard(){ return db.ref('dashboard').set(dashboard); }

function createDefault(){
  const weeks = [];
  for(let w=1; w<=4; w++){
    const week = { title:`الأسبوع ${w}`, days:[] };
    defaultDays.forEach(d=>{
      const rows = students.map((name,i)=>({ id:i,name, absence:'present', حفظ:'', تثبيت:'', مراجعة:'', سلوك:'', note:'' }));
      week.days.push({ title:d, date:'', rows });
    });
    weeks.push(week);
  }
  const tests = { exams:[], scores: students.map((s,i)=>({ id:i, name:s, grades:{} })) };
  const honor = { positions: [ {title:'المركز الأول', studentId:null, customName:''}, {title:'المركز الثاني', studentId:null, customName:''}, {title:'المركز الثالث', studentId:null, customName:''} ] };
  return { weeks, tests, honor };
}
function ensureStructure(){
  if(!dashboard) dashboard = createDefault();
  if(!Array.isArray(dashboard.weeks) || dashboard.weeks.length===0) dashboard.weeks = createDefault().weeks;
  if(!dashboard.tests) dashboard.tests = createDefault().tests;
  if(!dashboard.honor) dashboard.honor = createDefault().honor;
  dashboard.weeks.forEach((w,wi)=>{
    if(!Array.isArray(w.days) || w.days.length===0) w.days = createDefault().weeks[wi].days;
    w.days.forEach((d,di)=>{
      if(!Array.isArray(d.rows) || d.rows.length !== students.length){
        d.rows = students.map((name,i)=>({ id:i,name, absence:'present', حفظ:'', تثبيت:'', مراجعة:'', سلوك:'', note:'' }));
      }
    });
  });
  if(!dashboard.tests.scores || dashboard.tests.scores.length !== students.length){
    dashboard.tests.scores = students.map((s,i)=>({ id:i, name:s, grades:{} }));
  }
}

/* ---------- UI refs ---------- */
const enterBtn = document.getElementById('enterBtn'), logoutBtn = document.getElementById('logoutBtn'), codeInput = document.getElementById('codeInput');
const mainNav = document.getElementById('mainNav');

const visitorArea = document.getElementById('visitorArea'), visitorInput = document.getElementById('visitorInput'), visitorShow = document.getElementById('visitorShow'), visitorClear = document.getElementById('visitorClear');
const publicHonorList = document.getElementById('publicHonorList'), visitorResult = document.getElementById('visitorResult');

const appUI = document.getElementById('appUI'), weeksBox = document.getElementById('weeksBox'), weekTitle = document.getElementById('weekTitle'), gridWrap = document.getElementById('gridWrap');
const addWeekBtn = document.getElementById('addWeek'), delWeekBtn = document.getElementById('delWeek'), prevWeek = document.getElementById('prevWeek'), nextWeek = document.getElementById('nextWeek');
const suggestRankBtn = document.getElementById('suggestRankBtn');

const honorPage = document.getElementById('honorPage'), honorContent = document.getElementById('honorContent');

const supervisorOnly = document.getElementById('supervisorOnly'), supervisorContainer = document.getElementById('supervisorContainer');

const tabHome = document.getElementById('tabHome'), tabTests = document.getElementById('tabTests'), tabHonor = document.getElementById('tabHonor'), tabStats = document.getElementById('tabStats'), tabSupervisor = document.getElementById('tabSupervisor');

const testsPage = document.getElementById('testsPage'), testsContainer = document.getElementById('testsContainer');
const testsAddBtn = document.getElementById('testsAddBtn');

const statsPage = document.getElementById('statsPage'), statsContent = document.getElementById('statsContent');

/* ---------- role handling ---------- */
enterBtn.addEventListener('click', ()=>{
  const code = codeInput.value.trim();
  if(code==='0059'){ role='teacher'; }
  else if(code==='1234'){ role='supervisor'; }
  else { role='visitor'; }
  onRoleChange();
});
logoutBtn.addEventListener('click', ()=>{ role='visitor'; codeInput.value=''; onRoleChange(); });

function onRoleChange(){
  // hide everything first
  document.getElementById('visitorArea').style.display='none';
  appUI.style.display='none';
  mainNav.style.display='none';
  honorPage.style.display='none';
  testsPage.style.display='none';
  statsPage.style.display='none';
  supervisorOnly.style.display='none';

  if(role==='supervisor'){
    supervisorOnly.style.display='block';
    logoutBtn.style.display='inline-block';
    applyVisitorModeIfNeeded();
    renderSupervisorDetailed();
    return;
  }
  if(role==='teacher'){
    appUI.style.display='block';
    mainNav.style.display='flex';
    logoutBtn.style.display='inline-block';
    document.querySelectorAll('.teacher-only').forEach(el=>el.style.display='inline-block');
    setActiveNav('home');
    renderGrid();
    applyVisitorModeIfNeeded();
    return;
  }
  // visitor
  visitorArea.style.display='flex';
  mainNav.style.display='none';
  logoutBtn.style.display='none';
  visitorResult.innerHTML='';
  applyVisitorModeIfNeeded();
}

/* ---------- visitor-controls hiding functions ---------- */
function hideVisitorControls(){
  const selectors = [
    '.inline-btn',
    '.danger',
    '.teacher-only',
    '#suggestRankBtn',
    '#delWeek', '#addWeek', '#prevWeek', '#nextWeek'
  ];
  selectors.forEach(sel=>{
    document.querySelectorAll(sel).forEach(el=>{
      if(el){ el.style.display = 'none'; el.disabled = true; el.setAttribute('aria-hidden','true'); }
    });
  });
  document.querySelectorAll('#publicHonor input, #publicHonor select, #publicHonor button').forEach(el=>{
    el.style.display = 'none'; el.disabled = true; el.setAttribute('aria-hidden','true');
  });
  const keep = ['visitorShow','visitorClear'];
  document.querySelectorAll('#visitorArea button').forEach(btn=>{
    if(!keep.includes(btn.id)){ btn.style.display='none'; btn.disabled=true; }
  });
}
function restoreControls(){
  document.querySelectorAll('.inline-btn, .danger, .teacher-only, #suggestRankBtn, #delWeek, #addWeek, #prevWeek, #nextWeek').forEach(el=>{
    el.style.display = ''; el.disabled = false; el.removeAttribute('aria-hidden');
  });
  document.querySelectorAll('#publicHonor input, #publicHonor select, #publicHonor button').forEach(el=>{
    el.style.display = ''; el.disabled = false; el.removeAttribute('aria-hidden');
  });
  const vs = document.getElementById('visitorShow'); if(vs) vs.style.display = '';
  const vc = document.getElementById('visitorClear'); if(vc) vc.style.display = '';
}
function applyVisitorModeIfNeeded(){
  if(role === 'visitor') hideVisitorControls(); else restoreControls();
}

/* ---------- nav tabs ---------- */
function setActiveNav(n){ document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('active')); if(n==='home'&&tabHome) tabHome.classList.add('active'); if(n==='tests'&&tabTests) tabTests.classList.add('active'); if(n==='honor'&&tabHonor) tabHonor.classList.add('active'); if(n==='stats'&&tabStats) tabStats.classList.add('active'); if(n==='supervisor'&&tabSupervisor) tabSupervisor.classList.add('active'); }
tabHome && tabHome.addEventListener('click', ()=>{ currentTab='home'; setActiveNav('home'); showSection('home'); });
tabTests && tabTests.addEventListener('click', ()=>{ currentTab='tests'; setActiveNav('tests'); showSection('tests'); });
tabHonor && tabHonor.addEventListener('click', ()=>{ currentTab='honor'; setActiveNav('honor'); showSection('honor'); });
tabStats && tabStats.addEventListener('click', ()=>{ currentTab='stats'; setActiveNav('stats'); showSection('stats'); });
tabSupervisor && tabSupervisor.addEventListener('click', ()=>{ currentTab='supervisor'; setActiveNav('supervisor'); showSection('supervisor'); });

function showSection(name){
  visitorArea.style.display='none';
  appUI.style.display='none';
  honorPage.style.display='none';
  testsPage.style.display='none';
  statsPage.style.display='none';
  supervisorOnly.style.display='none';

  if(role==='visitor'){ visitorArea.style.display='flex'; applyVisitorModeIfNeeded(); return; }

  if(name==='home'){ appUI.style.display='block'; renderGrid(); }
  else if(name==='tests'){ testsPage.style.display='block'; renderTestsPage(); }
  else if(name==='honor'){ honorPage.style.display='block'; renderHonorEditor(); }
  else if(name==='stats'){ statsPage.style.display='block'; renderStatsPage(); }
  else if(name==='supervisor'){ supervisorOnly.style.display='block'; renderSupervisorDetailed(); }
  applyVisitorModeIfNeeded();
}

/* ---------- renderAll ---------- */
function renderAll(){
  renderPublicHonor();
  if(role==='visitor'){
    const sid = visitorResult.getAttribute('data-student-id'); if(sid) renderVisitorResult(Number(sid));
  } else if(role==='teacher'){
    renderWeeks(); renderGrid();
  }
  applyVisitorModeIfNeeded();
}

/* ---------- public honor (manual) ---------- */
function renderPublicHonor(){
  const c = publicHonorList;
  if(!dashboard || !dashboard.honor || !dashboard.honor.positions){ c.innerHTML='لا توجد مراكز'; return; }
  let html = '<ol style="text-align:right;padding-right:12px;margin:0">';
  dashboard.honor.positions.forEach((p,idx)=>{ const name = (p.studentId!==null && p.studentId!==undefined) ? students[p.studentId] : (p.customName||'—'); html += `<li style="margin:6px 0">${p.title||('المركز '+(idx+1))} — <strong>${name}</strong></li>`; });
  html += '</ol>'; c.innerHTML = html;
}

/* ---------- AI-weighted progress (client heuristic) ---------- */
function computeAiWeightedProgressForWeek(weekIndex, options={save:false}){
  const week = dashboard.weeks[weekIndex];
  if(!week) return null;
  // weights: emphasize حفظ and تثبيت, then مراجعة then سلوك
  const weights = { 'حفظ':0.35, 'تثبيت':0.35, 'مراجعة':0.2, 'سلوك':0.1 };
  const maxScorePerField = 3; // tokens map 0..3
  const daysCount = week.days.length || 1;
  const percents = new Array(students.length).fill(0);
  const totals = new Array(students.length).fill(0);

  for(let si=0; si<students.length; si++){
    let score = 0;
    let absencePenalty = 0;
    for(let di=0; di<daysCount; di++){
      const r = week.days[di].rows[si];
      // fields
      Object.keys(weights).forEach(f=>{
        const val = tokenToNumber(r[f]);
        // normalized contribution 0..1 per field
        score += (val / maxScorePerField) * weights[f];
      });
      // absence penalties (heuristic): excused small penalty, unexcused larger, late small
      if(r.absence==='excused') absencePenalty += 0.02; // -2%
      if(r.absence==='unexcused') absencePenalty += 0.08; // -8%
      if(r.absence==='late') absencePenalty += 0.01; // -1%
    }
    // average over days -> score in 0..1
    const normalized = score / daysCount;
    // apply penalty
    let finalScore = normalized - absencePenalty;
    if(finalScore < 0) finalScore = 0;
    let percent = Math.round(finalScore * 100);
    if(percent < 0) percent = 0; if(percent > 100) percent = 100;
    percents[si] = percent;
    totals[si] = Math.round(normalized * daysCount * maxScorePerField); // auxiliary
  }

  week.aiProgress = week.aiProgress || {};
  week.aiProgress.percents = percents;
  week.aiProgress.totals = totals;
  // messages per student
  week.aiProgress.messages = percents.map(p=> p<80? 'يحتاج متابعة' : (p<=90? 'جيد' : 'ممتاز واصل يا بطل'));
  if(options.save) saveDashboard();
  return { percents, totals, messages: week.aiProgress.messages };
}

/* ---------- check week completion ---------- */
function isWeekComplete(week){
  if(!week || !Array.isArray(week.days) || week.days.length===0) return false;
  for(const d of week.days){
    if(!d.rows || d.rows.length!==students.length) return false;
    for(const r of d.rows){
      if(!r) return false;
      const fields = ['حفظ','تثبيت','مراجعة','سلوك'];
      for(const f of fields){
        if(!r[f] && r[f] !== 0 && r[f] !== '0') return false;
      }
    }
  }
  return true;
}

// check if a specific student has complete data for ALL days of a week
function isStudentCompleteInWeek(week, studentIndex){
  if(!week || !Array.isArray(week.days) || week.days.length===0) return false;
  const fields = ['حفظ','تثبيت','مراجعة','سلوك'];
  for(const d of week.days){
    const r = d.rows && d.rows[studentIndex];
    if(!r) return false;
    for(const f of fields){
      if(!r[f] && r[f] !== 0 && r[f] !== '0') return false;
    }
  }
  return true;
}

/* ---------- compute progress for week (original) ---------- */
function computeProgressForWeek(weekIndex, options={save:false}){
  const week = dashboard.weeks[weekIndex];
  if(!week) return null;
  const daysCount = week.days.length;
  const fieldsPerDay = ['حفظ','تثبيت','مراجعة','سلوك'];
  const maxPossible = daysCount * fieldsPerDay.length * 3;
  const totals = new Array(students.length).fill(0);
  for(let di=0; di<daysCount; di++){ const d = week.days[di]; d.rows.forEach((r,si)=>{ fieldsPerDay.forEach(f=>{ totals[si] += tokenToNumber(r[f]); }); }); }
  const percents = totals.map(t=> maxPossible>0 ? (t / maxPossible) * 100 : 0 );
  const messages = percents.map(p=> p<80? 'يحتاج متابعة' : (p<=90? 'جيد' : 'ممتاز واصل يا بطل') );
  week.computed = week.computed || {};
  week.computed.totals = totals; week.computed.percents = percents; week.computed.messages = messages;
  // also compute ai progress and store
  computeAiWeightedProgressForWeek(weekIndex, { save:false });
  if(options.save) saveDashboard();
  return { totals, percents, messages, maxPossible };
}

/* ---------- suggest ranking ---------- */
function suggestRankingForWeek(weekIndex, topN=3){
  const comp = computeProgressForWeek(weekIndex, { save:false });
  if(!comp) return [];
  const order = comp.totals.map((t,i)=>({ id:i, total:t, percent: Math.round(comp.percents[i]) })).sort((a,b)=>b.total - a.total);
  return order.slice(0, topN);
}

/* ---------- show suggestion modal ---------- */
function showSuggestionModal(suggested){
  const overlay = document.createElement('div'); overlay.className='modal-overlay';
  const modal = document.createElement('div'); modal.className='modal';
  modal.innerHTML = `<h3>اقتراح ترتيب آلي للأسبوع</h3><div id="suggestList"></div><div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end"><button id="applySuggest" class="primary">تطبيق الاقتراح</button><button id="closeSuggest">إغلاق</button></div>`;
  overlay.appendChild(modal); document.body.appendChild(overlay);
  const listEl = modal.querySelector('#suggestList');
  let html = '<ol style="text-align:right;">';
  suggested.forEach((s,idx)=>{ html += `<li>${idx+1}. ${students[s.id]} — ${s.percent}%</li>`; });
  html += '</ol>'; listEl.innerHTML = html;
  modal.querySelector('#closeSuggest').onclick = ()=>{ document.body.removeChild(overlay); };
  modal.querySelector('#applySuggest').onclick = ()=>{ 
    dashboard.honor = dashboard.honor || { positions:[] };
    dashboard.honor.positions = [];
    suggested.forEach((s,idx)=>{ dashboard.honor.positions.push({ title: idx===0?'المركز الأول':idx===1?'المركز الثاني':idx===2?'المركز الثالث':('المركز '+(idx+1)), studentId: s.id, customName: '' }); });
    saveDashboard(); renderPublicHonor(); renderHonorEditor(); document.body.removeChild(overlay); alert('تم تطبيق الاقتراح إلى لوحة الشرف.'); 
  };
}

/* ---------- render grid (teacher) ---------- */
function renderGrid(){
  gridWrap.innerHTML='';
  if(role!=='teacher') return;
  const week = dashboard.weeks[currentWeek];
  if(!week) return;
  // ensure AI progress for the current week is computed
  computeAiWeightedProgressForWeek(currentWeek, { save:false });

  weekTitle.innerHTML = `<h3 style="margin:6px 0">${week.title} — ${week.days[currentDay].title || ('اليوم '+(currentDay+1))} <span class="small"> ${week.days[currentDay].date?(' - '+week.days[currentDay].date):''}</span></h3>`;

  // determine if at least one student has complete data for showing the progress column
  const anyStudentComplete = students.some((_,si)=> isStudentCompleteInWeek(week, si));

  const table = document.createElement('table');
  const headerCols = `<tr><th>الطالب</th><th>غياب</th><th>حفظ</th><th>تثبيت</th><th>مراجعة</th><th>سلوك</th><th>ملاحظة</th>${anyStudentComplete?'<th>تقدم</th>':''}</tr>`;
  const thead = document.createElement('thead'); thead.innerHTML = headerCols; table.appendChild(thead);
  const tbody = document.createElement('tbody');

  week.days[currentDay].rows.forEach((row,si)=>{
    const tr = document.createElement('tr'); if(row.absence==='excused' || row.absence==='unexcused') tr.classList.add('faded'); tr.classList.add('fade');
    const tdName = document.createElement('td'); tdName.textContent = row.name; tr.appendChild(tdName);

    const tdAbs = document.createElement('td'); tdAbs.textContent = absenceLabel(row.absence); tdAbs.style.cursor='pointer';
    tdAbs.onclick = ()=>{ if(row.absence==='present' || !row.absence) row.absence='excused'; else if(row.absence==='excused') row.absence='unexcused'; else if(row.absence==='unexcused') row.absence='late'; else row.absence='present'; saveDashboard(); renderGrid(); };
    tr.appendChild(tdAbs);

    const makeScoreCell = (field)=>{ const td=document.createElement('td'); const sel=document.createElement('select'); sel.className='score-select'; const opts=[{v:'3-star',t:'3 ⭐️'},{v:'3-check',t:'3 ✅'},{v:'2',t:'2 ⚠️'},{v:'1',t:'1 ⚠️'},{v:'0',t:'0 ❌'},{v:'',t:'إفراغ'}]; opts.forEach(o=>{ const op=document.createElement('option'); op.value=o.v; op.textContent=o.t; if(row[field]===o.v) op.selected=true; sel.appendChild(op); }); sel.onchange = ()=>{ row[field]=sel.value; saveDashboard(); renderGrid(); }; td.appendChild(sel); return td; };
    tr.appendChild(makeScoreCell('حفظ')); tr.appendChild(makeScoreCell('تثبيت')); tr.appendChild(makeScoreCell('مراجعة')); tr.appendChild(makeScoreCell('سلوك'));

    const tdNote = document.createElement('td'); const ta=document.createElement('textarea'); ta.value=row.note||''; ta.onchange=()=>{ row.note=ta.value; saveDashboard(); }; tdNote.appendChild(ta); tr.appendChild(tdNote);

    // show per-student progress only if that student has complete data for the week
    if(isStudentCompleteInWeek(week, si)){
      const percent = Math.round((week.aiProgress && week.aiProgress.percents) ? week.aiProgress.percents[si] : 0);
      const msg = (week.aiProgress && week.aiProgress.messages && week.aiProgress.messages[si])? week.aiProgress.messages[si] : '';
      const tdProg = document.createElement('td'); tdProg.innerHTML = renderProgressBarHtml(percent,msg); tr.appendChild(tdProg);
    } else if(anyStudentComplete){
      // add empty cell to keep columns aligned if some students have progress but this one doesn't
      const tdEmpty = document.createElement('td'); tdEmpty.innerHTML = '<span class="small muted">غير مكتمل</span>'; tr.appendChild(tdEmpty);
    }

    tbody.appendChild(tr);
  });

  table.appendChild(tbody); gridWrap.appendChild(table);
  const daysNav = document.createElement('div'); daysNav.style.marginTop='8px';
  dashboard.weeks[currentWeek].days.forEach((d,di)=>{ const b=document.createElement('button'); b.className='week-btn '+(di===currentDay?'active':''); b.textContent=d.title||(`اليوم ${di+1}`); b.onclick=()=>{ currentDay=di; renderGrid(); }; daysNav.appendChild(b); });
  const editDayBtn=document.createElement('button'); editDayBtn.className='inline-btn'; editDayBtn.textContent='تعديل اسم/تاريخ'; editDayBtn.onclick=()=>{ const newT=prompt('اسم اليوم:', dashboard.weeks[currentWeek].days[currentDay].title||('اليوم '+(currentDay+1))); if(newT!==null) dashboard.weeks[currentWeek].days[currentDay].title=newT; const newD=prompt('تاريخ (YYYY-MM-DD):', dashboard.weeks[currentWeek].days[currentDay].date||''); if(newD!==null) dashboard.weeks[currentWeek].days[currentDay].date=newD; saveDashboard(); renderAll(); };
  const addDayBtn=document.createElement('button'); addDayBtn.className='inline-btn'; addDayBtn.textContent='+ يوم'; addDayBtn.onclick=()=>{ const title=prompt('اسم اليوم الجديد:','يوم جديد'); if(title===null) return; const rows = students.map((name,i)=>({ id:i,name, absence:'present', حفظ:'', تثبيت:'', مراجعة:'', سلوك:'', note:'' })); dashboard.weeks[currentWeek].days.push({ title, date:'', rows }); saveDashboard(); renderAll(); };
  daysNav.appendChild(editDayBtn); daysNav.appendChild(addDayBtn); gridWrap.appendChild(daysNav);
}

/* ---------- renderProgress helper ---------- */
function renderProgressBarHtml(percent,msg){
  const p = Math.round(percent);
  let badgeHtml = '', color = 'var(--excellent)';
  if(p < 80){ badgeHtml = `<span class="badge bad">يحتاج متابعة</span>`; color='var(--bad)'; }
  else if(p >=80 && p <=90){ badgeHtml = `<span class="badge warn">جيد ⚠️</span>`; color='var(--good)'; }
  else { badgeHtml = `<span class="badge ok">ممتاز ⭐️</span>`; color='var(--excellent)'; }
  const html = `<div class="progress-wrap"><div class="progress-bar"><div class="progress-fill" style="width:${p}%;background:${color}"></div></div><div style="margin-top:6px;font-size:13px">${p}% ${msg?('<div class="small muted">'+escapeHtml(msg)+'</div>'):''}</div>${badgeHtml}</div>`;
  return html;
}
function escapeHtml(s){ return (''+s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* ---------- renderHonorEditor ---------- */
function renderHonorEditor(){
  honorContent.innerHTML = '';
  if(!dashboard.honor) dashboard.honor = { positions:[] };
  if(dashboard.honor.positions.length===0) dashboard.honor.positions = [ {title:'المركز الأول', studentId:null, customName:''}, {title:'المركز الثاني', studentId:null, customName:''}, {title:'المركز الثالث', studentId:null, customName:''} ];
  const wrapper = document.createElement('div');
  dashboard.honor.positions.forEach((p,idx)=>{
    const row = document.createElement('div'); row.style.display='flex'; row.style.gap='8px'; row.style.marginBottom='6px'; row.style.alignItems='center';
    const medal = document.createElement('div'); medal.textContent = idx===0?'🥇':idx===1?'🥈':idx===2?'🥉':'🏅';
    const titleInp = document.createElement('input'); titleInp.value = p.title||('المركز '+(idx+1)); titleInp.onchange = ()=>{ p.title = titleInp.value; saveDashboard(); renderPublicHonor(); };
    const sel = document.createElement('select'); const emptyOpt = document.createElement('option'); emptyOpt.value=''; emptyOpt.textContent='— اختَر طالب —'; sel.appendChild(emptyOpt);
    students.forEach((s,sid)=>{ const o=document.createElement('option'); o.value=sid; o.textContent=s; if(p.studentId===sid) o.selected=true; sel.appendChild(o); });
    sel.onchange = ()=>{ const v = sel.value; p.studentId = v===''? null : Number(v); saveDashboard(); renderPublicHonor(); };
    const custom = document.createElement('input'); custom.placeholder='اسم مخصص (اختياري)'; custom.value = p.customName||''; custom.onchange = ()=>{ p.customName = custom.value; saveDashboard(); renderPublicHonor(); };
    const rem = document.createElement('button'); rem.textContent='إزالة'; rem.onclick = ()=>{ if(confirm('حذف؟')){ dashboard.honor.positions.splice(idx,1); saveDashboard(); renderHonorEditor(); } };
    row.append(medal,titleInp,sel,custom,rem); wrapper.appendChild(row);
  });
  const add = document.createElement('button'); add.textContent='+ مركز'; add.onclick = ()=>{ dashboard.honor.positions.push({ title:'المركز '+(dashboard.honor.positions.length+1), studentId:null, customName:'' }); saveDashboard(); renderHonorEditor(); };
  const clearBtn = document.createElement('button'); clearBtn.textContent='مسح المراكز'; clearBtn.className='danger'; clearBtn.onclick = ()=>{ if(confirm('مسح جميع المراكز؟')){ dashboard.honor.positions=[]; saveDashboard(); renderHonorEditor(); renderPublicHonor(); } };
  wrapper.appendChild(add); wrapper.appendChild(clearBtn);
  honorContent.appendChild(wrapper);
}

/* ---------- visitor display ---------- */
visitorShow.addEventListener('click', ()=>{ const name = visitorInput.value.trim(); if(!name) return alert('اكتب الاسم'); const sid = students.indexOf(name); if(sid===-1) return alert('الاسم غير موجود'); renderVisitorResult(sid); });
visitorClear.addEventListener('click', ()=>{ visitorInput.value=''; visitorResult.innerHTML=''; visitorResult.removeAttribute('data-student-id'); });

function renderVisitorResult(studentId){
  visitorResult.innerHTML = ''; visitorResult.setAttribute('data-student-id', String(studentId));
  dashboard.weeks.forEach((w,wi)=>{
    const weekComplete = isWeekComplete(w);
    const t = document.createElement('table'); let header = '<tr><th>اليوم</th><th>التاريخ</th><th>غياب</th><th>حفظ</th><th>تثبيت</th><th>مراجعة</th><th>سلوك</th><th>ملاحظة</th></tr>';
    let rows = '';
    w.days.forEach((d,di)=>{ const r = d.rows.find(rr=>rr.id===studentId); rows += `<tr><td>${d.title}</td><td>${d.date||''}</td><td>${absenceLabel(r.absence)}</td><td>${tokenToEmoji(r['حفظ'])} ${tokenToNumber(r['حفظ'])||''}</td><td>${tokenToEmoji(r['تثبيت'])} ${tokenToNumber(r['تثبيت'])||''}</td><td>${tokenToEmoji(r['مراجعة'])} ${tokenToNumber(r['مراجعة'])||''}</td><td>${tokenToEmoji(r['سلوك'])} ${tokenToNumber(r['سلوك'])||''}</td><td>${r.note||''}</td></tr>`; });
    t.innerHTML = `<caption>${w.title}</caption>` + header + rows; visitorResult.appendChild(t);

    if(weekComplete){
      computeProgressForWeek(wi, { save:false });
      const percent = Math.round((w.aiProgress && w.aiProgress.percents && w.aiProgress.percents[studentId]) ? w.aiProgress.percents[studentId] : 0);
      const msg = (w.aiProgress && w.aiProgress.messages && w.aiProgress.messages[studentId]) ? w.aiProgress.messages[studentId] : '';
      const progWrap = document.createElement('div'); progWrap.style.marginTop='8px'; progWrap.innerHTML = `<strong>${w.title} — التقدم: ${percent}%</strong><div style="margin-top:6px">${renderProgressBarHtml(percent,msg)}</div>`;
      visitorResult.appendChild(progWrap);
    } else {
      const note = document.createElement('div'); note.className='small muted'; note.style.marginTop='8px'; note.textContent = 'لا يمكن حساب التقدّم لهذا الأسبوع لأن بياناته غير مكتملة بعد.'; visitorResult.appendChild(note);
    }
  });

  // tests
  const testsDiv = document.createElement('div'); testsDiv.style.marginTop='8px'; testsDiv.innerHTML = '<h3>الاختبارات</h3>';
  if(!dashboard.tests || !dashboard.tests.exams || dashboard.tests.exams.length===0){ testsDiv.innerHTML += '<p class="muted">لا توجد اختبارات</p>'; visitorResult.appendChild(testsDiv); return; }
  const table = document.createElement('table'); table.innerHTML = '<tr><th>الاختبار</th><th>الدرجة</th></tr>';
  const st = dashboard.tests.scores.find(s=>s.id===studentId);
  dashboard.tests.exams.forEach(ex=>{ const tr = document.createElement('tr'); tr.innerHTML = `<td>${ex}</td><td>${ (st && st.grades && st.grades[ex] !== undefined) ? st.grades[ex] : '' }</td>`; table.appendChild(tr); });
  testsDiv.appendChild(table); visitorResult.appendChild(testsDiv);
}

function renderInlineProgressBar(percent,msg){
  const p = Math.round(percent);
  let badge = '';
  if(p<80) badge = `<span class="badge bad">${msg}</span>`;
  else if(p<=90) badge = `<span class="badge warn">${msg}</span>`;
  else badge = `<span class="badge ok">${msg}</span>`;
  return `<div style="display:flex;gap:8px;align-items:center"><div style="flex:1"><div class="progress-bar"><div class="progress-fill" style="width:${p}%;background:${p<80?'var(--bad)':(p<=90?'var(--good)':'var(--excellent)')}"></div></div></div><div style="min-width:90px;text-align:right">${p}% ${badge}</div></div>`;
}

function renderVisitorResult(studentId){
  visitorResult.innerHTML = ''; visitorResult.setAttribute('data-student-id', String(studentId));
  dashboard.weeks.forEach((w,wi)=>{
    // ensure AI progress computed for this week
    computeAiWeightedProgressForWeek(wi, { save:false });

    const t = document.createElement('table'); let header = '<tr><th>اليوم</th><th>التاريخ</th><th>غياب</th><th>حفظ</th><th>تثبيت</th><th>مراجعة</th><th>سلوك</th><th>ملاحظة</th></tr>';
    let rows = '';
    w.days.forEach((d,di)=>{ const r = d.rows.find(rr=>rr.id===studentId); rows += `<tr><td>${d.title}</td><td>${d.date||''}</td><td>${absenceLabel(r.absence)}</td><td>${tokenToEmoji(r['حفظ'])} ${tokenToNumber(r['حفظ'])||''}</td><td>${tokenToEmoji(r['تثبيت'])} ${tokenToNumber(r['تثبيت'])||''}</td><td>${tokenToEmoji(r['مراجعة'])} ${tokenToNumber(r['مراجعة'])||''}</td><td>${tokenToEmoji(r['سلوك'])} ${tokenToNumber(r['سلوك'])||''}</td><td>${r.note||''}</td></tr>`; });
    t.innerHTML = `<caption>${w.title}</caption>` + header + rows; visitorResult.appendChild(t);

    // show per-student progress only if that student has complete data for the week
    if(isStudentCompleteInWeek(w, studentId)){
      const percent = Math.round((w.aiProgress && w.aiProgress.percents && w.aiProgress.percents[studentId]) ? w.aiProgress.percents[studentId] : 0);
      const msg = (w.aiProgress && w.aiProgress.messages && w.aiProgress.messages[studentId]) ? w.aiProgress.messages[studentId] : '';
      const progWrap = document.createElement('div'); progWrap.style.marginTop='8px'; progWrap.innerHTML = `<strong>${w.title} — التقدم: ${percent}%</strong><div style="margin-top:6px">${renderProgressBarHtml(percent,msg)}</div>`;
      visitorResult.appendChild(progWrap);
    } else {
      const note = document.createElement('div'); note.className='small muted'; note.style.marginTop='8px'; note.textContent = 'لا يمكن حساب التقدّم لهذا الأسبوع لأن بيانات هذا الطالب غير مكتملة بعد.'; visitorResult.appendChild(note);
    }
  });

  // tests
  const testsDiv = document.createElement('div'); testsDiv.style.marginTop='8px'; testsDiv.innerHTML = '<h3>الاختبارات</h3>';
  if(!dashboard.tests || !dashboard.tests.exams || dashboard.tests.exams.length===0){ testsDiv.innerHTML += '<p class="muted">لا توجد اختبارات</p>'; visitorResult.appendChild(testsDiv); return; }
  const table = document.createElement('table'); table.innerHTML = '<tr><th>الاختبار</th><th>الدرجة</th></tr>';
  const st = dashboard.tests.scores.find(s=>s.id===studentId);
  dashboard.tests.exams.forEach(ex=>{ const tr = document.createElement('tr'); tr.innerHTML = `<td>${ex}</td><td>${ (st && st.grades && st.grades[ex] !== undefined) ? st.grades[ex] : '' }</td>`; table.appendChild(tr); });
  testsDiv.appendChild(table); visitorResult.appendChild(testsDiv);
}

/* ---------- supervisor detailed ---------- */
function renderSupervisorDetailed(){
  supervisorContainer.innerHTML=''; const container=document.createElement('div'); container.style.padding='8px';
  dashboard.weeks.forEach((w,wi)=>{ const h=document.createElement('h3'); h.textContent = w.title; container.appendChild(h);
    if(!w.aiProgress || !w.aiProgress.percents) computeAiWeightedProgressForWeek(wi, { save:false });
    const t=document.createElement('table'); let header='<tr><th>الطالب</th>'; w.days.forEach(d=> header += `<th>${d.title} (غياب)</th><th>${d.title} (حفظ)</th><th>${d.title} (تثبيت)</th><th>${d.title} (مراجعة)</th><th>${d.title} (سلوك)</th>`); header += '<th>تقدّم %</th></tr>'; t.innerHTML = header;
    const tb=document.createElement('tbody');
    for(let si=0; si<students.length; si++){
      let rowHtml = `<tr><td>${students[si]}</td>`;
      w.days.forEach(d=>{
        const r = d.rows[si];
        rowHtml += `<td>${absenceLabel(r.absence)}</td><td>${tokenToEmoji(r['حفظ'])} ${tokenToNumber(r['حفظ'])||''}</td><td>${tokenToEmoji(r['تثبيت'])} ${tokenToNumber(r['تثبيت'])||''}</td><td>${tokenToEmoji(r['مراجعة'])} ${tokenToNumber(r['مراجعة'])||''}</td><td>${tokenToEmoji(r['سلوك'])} ${tokenToNumber(r['سلوك'])||''}</td>`;
      });
      const percent = w.aiProgress && w.aiProgress.percents ? Math.round(w.aiProgress.percents[si]||0) : 0;
      rowHtml += `<td>${percent}%</td></tr>`; tb.insertAdjacentHTML('beforeend', rowHtml);
    }
    t.appendChild(tb); container.appendChild(t);
  });
  supervisorContainer.appendChild(container);
}

/* ---------- tests page (teacher) ---------- */
function renderTestsPage(){
  testsContainer.innerHTML = '';
  // make sure structure exists and is safe to read
  if(!dashboard) dashboard = createDefault();
  if(!dashboard.tests) dashboard.tests = { exams:[], scores: students.map((s,i)=>({id:i,name:s,grades:{}})) };
  if(!Array.isArray(dashboard.tests.exams)) dashboard.tests.exams = [];
  if(!Array.isArray(dashboard.tests.scores) || dashboard.tests.scores.length !== students.length) dashboard.tests.scores = students.map((s,i)=>({id:i,name:s,grades:{}}));

  const wrapper = document.createElement('div');
  if(dashboard.tests.exams.length===0){
    const p=document.createElement('p'); p.className='muted'; p.textContent='لا توجد اختبارات مضافة';
    wrapper.appendChild(p);
  } else {
    const table=document.createElement('table'); let header='<tr><th>الطالب</th>';
    dashboard.tests.exams.forEach(ex=> header += `<th style="min-width:120px">${ex} ${ role==='teacher' ? `<button class="inline-btn" onclick="deleteExam('${escapeAttr(ex)}')">حذف</button>` : '' }</th>` );
    header += '</tr>'; table.innerHTML = header;
    const tbody=document.createElement('tbody');
    dashboard.tests.scores.forEach(st=>{
      const tr=document.createElement('tr'); tr.innerHTML = `<td>${st.name}</td>`;
      dashboard.tests.exams.forEach(ex=>{
        const td=document.createElement('td');
        if(role==='teacher'){
          td.contentEditable=true;
          td.innerText = st.grades && st.grades[ex] !== undefined ? st.grades[ex] : '';
          td.onblur = ()=>{ if(!st.grades) st.grades={}; const v=td.innerText.trim(); st.grades[ex]=(v===''? '' : (isNaN(Number(v))? v : Number(v))); saveDashboard(); };
        } else {
          td.innerText = st.grades && st.grades[ex] !== undefined ? st.grades[ex] : '';
        }
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    wrapper.appendChild(table);
  }
  testsContainer.appendChild(wrapper);

  // Ensure add button visibility and attach handler (fresh each render)
  const addBtn = document.getElementById('testsAddBtn');
  if(addBtn){
    addBtn.style.display = (role==='teacher' ? 'inline-block' : 'none');
    // remove previous handler to avoid duplicates
    addBtn.onclick = function(){
      if(role!=='teacher') return alert('غير مصرح');
      const name = prompt('اسم الاختبار:');
      if(!name) return;
      if(!dashboard.tests) dashboard.tests={exams:[],scores: students.map((s,i)=>({id:i,name:s,grades:{}}))};
      if(dashboard.tests.exams.includes(name)){ alert('الاختبار موجود'); return; }
      dashboard.tests.exams.push(name);
      dashboard.tests.scores.forEach(st=>{ if(!st.grades) st.grades={}; st.grades[name]=''; });
      saveDashboard().then(()=>{
        return db.ref('dashboard').get();
      }).then(snap=>{
        if(snap.exists()){ dashboard = snap.val(); ensureStructure(); }
        // re-render tests page after update
        renderTestsPage();
      }).catch(err=>{ console.error(err); alert('حدث خطأ أثناء الحفظ: '+err.message); renderTestsPage(); });
    };
  }
}

window.deleteExam = function(ex){ if(role!=='teacher') return; if(!confirm('حذف الاختبار "'+ex+'"؟')) return; dashboard.tests.exams = dashboard.tests.exams.filter(e=>e!==ex); dashboard.tests.scores.forEach(s=>{ if(s.grades) delete s.grades[ex]; }); saveDashboard(); renderTestsPage(); };

/* ---------- stats page ---------- */
function renderStatsPage(){
  statsContent.innerHTML = '';
  const table=document.createElement('table');
  table.innerHTML = '<tr><th>الطالب</th><th>غائب بعذر</th><th>غائب بدون</th><th>تأخير</th></tr>';
  const tbody=document.createElement('tbody');
  const counts = students.map(()=>({excused:0,unexcused:0,late:0}));
  dashboard.weeks.forEach(week=>{
    week.days.forEach(day=>{
      day.rows.forEach(r=>{
        if(r.absence==='excused') counts[r.id].excused++;
        if(r.absence==='unexcused') counts[r.id].unexcused++;
        if(r.absence==='late') counts[r.id].late++;
      });
    });
  });
  students.forEach((s,i)=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${s}</td><td>${counts[i].excused}</td><td>${counts[i].unexcused}</td><td>${counts[i].late}</td>`; tbody.appendChild(tr); });
  table.appendChild(tbody);
  statsContent.appendChild(table);
}

/* ---------- utils ---------- */
function escapeAttr(s){ return (''+s).replace(/'/g,"\\'").replace(/\"/g,"\\\""); }

/* ---------- compute all weeks initial ---------- */
function computeAllWeeksIfMissing(){ dashboard.weeks.forEach((w,wi)=>{ if(!w.computed || !w.computed.percents) computeProgressForWeek(wi, { save:false }); if(!w.aiProgress || !w.aiProgress.percents) computeAiWeightedProgressForWeek(wi, { save:false }); }); }

/* ---------- render weeks (teacher) ---------- */
function renderWeeks(){ weeksBox.innerHTML=''; dashboard.weeks.forEach((w,idx)=>{ const b=document.createElement('button'); b.className='week-btn '+(idx===currentWeek?'active':'');
  // button content column: title + small progress (if complete)
  const titleDiv = document.createElement('div'); titleDiv.textContent = w.title||`الأسبوع ${idx+1}`;
  b.appendChild(titleDiv);
  // compute ai progress if complete
  const complete = isWeekComplete(w);
  if(complete){ if(!w.aiProgress || !w.aiProgress.percents) computeAiWeightedProgressForWeek(idx, { save:false }); const avg = Math.round(w.aiProgress.percents.reduce((a,b)=>a+b,0)/w.aiProgress.percents.length); const progDiv = document.createElement('div'); progDiv.style.marginTop='6px'; progDiv.style.width='120px'; progDiv.innerHTML = renderInlineProgressBar(avg, avg<80? 'يحتاج متابعة' : (avg<=90? 'جيد' : 'ممتاز واصل يا بطل')); b.appendChild(progDiv); }
  b.onclick=()=>{ currentWeek=idx; currentDay=0; renderGrid(); };
  weeksBox.appendChild(b); }); }

/* ---------- init ---------- */
if(addWeekBtn){
  addWeekBtn.addEventListener('click', ()=>{
    if(role!=='teacher') return alert('غير مصرح');
    const name = prompt('اسم الأسبوع:', `الأسبوع ${dashboard.weeks.length+1}`);
    if(name===null) return;
    const days = defaultDays.map(d=>({ title:d, date:'', rows: students.map((s,i)=>({ id:i,name:s, absence:'present', حفظ:'', تثبيت:'', مراجعة:'', سلوك:'', note:'' })) }));
    dashboard.weeks.push({ title: name, days });
    currentWeek = dashboard.weeks.length - 1;
    saveDashboard().then(()=>{ renderWeeks(); renderGrid(); });
  });
}
if(delWeekBtn){
  delWeekBtn.addEventListener('click', ()=>{
    if(role!=='teacher') return alert('غير مصرح');
    if(!confirm('هل تريد حذف الأسبوع الحالي؟')) return;
    if(dashboard.weeks.length<=1){ alert('لا يمكن حذف آخر أسبوع'); return; }
    dashboard.weeks.splice(currentWeek,1);
    if(currentWeek > dashboard.weeks.length-1) currentWeek = dashboard.weeks.length-1;
    saveDashboard().then(()=>{ renderWeeks(); renderGrid(); });
  });
}
if(prevWeek){ prevWeek.addEventListener('click', ()=>{ if(currentWeek>0) currentWeek--; renderWeeks(); renderGrid(); }); }
if(nextWeek){ nextWeek.addEventListener('click', ()=>{ if(currentWeek < dashboard.weeks.length-1) currentWeek++; else { const name = `الأسبوع ${dashboard.weeks.length+1}`; const days = defaultDays.map(d=>({ title:d, date:'', rows: students.map((s,i)=>({ id:i,name:s, absence:'present', حفظ:'', تثبيت:'', مراجعة:'', سلوك:'', note:'' })) })); dashboard.weeks.push({ title: name, days }); currentWeek = dashboard.weeks.length-1; saveDashboard(); } renderWeeks(); renderGrid(); }); }

/* ---------- last step init ---------- */
loadDashboard().then(()=>{ computeAllWeeksIfMissing(); renderAll(); applyVisitorModeIfNeeded(); });

</script>
</body>
</html>